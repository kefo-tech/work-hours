<!-- index.html â€“ Ø§Ù„Ø¬Ø²Ø¡ 1/3 -->
<!DOCTYPE html>
<!--
  KeFo Work Hours â€“ PWA
  Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ ØªÙ‚ÙˆÙŠÙ… + PDF Ø£ÙÙ‚ÙŠ Ù…Ù†Ø¸Ù… + 3 Ù„ØºØ§Øª + PWA + Firebase + Login KeFo + Sync
-->
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeFo Work Hours</title>

  <!-- manifest Ù„ØªØ·Ø¨ÙŠÙ‚ PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <!-- Ù„ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª -->
  <meta name="theme-color" content="#0f172a">
  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
  <link rel="icon" href="icons/icon-512.png">

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937;
      --muted:#9ca3af; --text:#e5e7eb;
      --primary:#22d3ee; --accent:#a78bfa; --success:#34d399;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}

    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.15), transparent),
        radial-gradient(800px 400px at 10% 110%, rgba(34,211,238,.12), transparent),
        var(--bg);
      color:var(--text);
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
    }

    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:clamp(10px,3vw,16px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:clamp(6px,2vw,12px);flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      color:#0b1020;font-weight:800;box-shadow:var(--shadow)
    }
    h1{font-size:1.25rem;margin:0;font-weight:800}

    .summary{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .chip{
      background:var(--panel-2);border:1px solid rgba(255,255,255,.06);
      padding:6px clamp(8px,2vw,12px);border-radius:999px;
      font-size:clamp(.78rem,2.4vw,.92rem);
      display:flex;gap:6px;align-items:center;min-height:32px
    }
    .chip b{color:#fff}

    .btn{
      appearance:none;border:0;background:var(--panel-2);color:var(--text);
      padding:8px 12px;border-radius:12px;cursor:pointer;
      box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.06);
      font-weight:700;transition:.2s transform,.2s opacity
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#0b1020}
    .btn-danger{background:linear-gradient(135deg,#fb7185,#fbbf24);color:#0b1020}

    main{max-width:1100px;margin:clamp(12px,3.5vw,24px) auto;padding:clamp(10px,3vw,16px)}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:clamp(12px,3vw,16px);overflow:hidden
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ */
    #setup{max-width:680px;margin:56px auto}
    .q{display:flex;flex-direction:column;gap:10px;margin:14px 0}
    label{color:#cbd5e1;font-weight:700}
    input[type="number"],input[type="time"],input[type="text"],select{
      width:100%;background:var(--panel);border:1px solid rgba(255,255,255,.08);
      color:var(--text);padding:12px 14px;border-radius:12px;outline:none
    }
    .hint{color:var(--muted);font-size:.9rem}

    /* Ø§Ù„ØªÙ‚ÙˆÙŠÙ… */
    .month-header{
      display:grid;grid-template-columns:1fr auto 1fr;
      align-items:center;margin-bottom:10px
    }
    .month-title{
      text-align:center;font-size:clamp(1.05rem,4vw,1.3rem);font-weight:900
    }
    .nav{display:flex;gap:8px}

    .cal-grid{
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:6px;width:100%
    }
    .dow{
      text-align:center;font-weight:700;color:var(--muted);
      font-size:clamp(.8rem,2.2vw,.95rem);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      line-height:1.5;padding:8px 0;
    }

    .day{
      background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;
      display:flex;flex-direction:column;align-items:center;justify-content:space-between;
      min-height:clamp(70px,13vw,100px);padding:6px;position:relative;
    }
    .day.disabled{opacity:.35;filter:grayscale(30%)}
    .today{outline:2px dashed var(--primary);outline-offset:2px}
    .day .dnum{font-weight:700;color:#fff;font-size:clamp(.9rem,2.8vw,1rem);margin-top:4px}
    .day .edit{
      position:absolute;top:6px;right:6px;background:none;border:none;color:var(--muted);
      cursor:pointer;font-size:.9rem;line-height:1;padding:2px 4px;border-radius:8px;
      transition:.2s;user-select:none;
    }
    .day .edit:hover{color:var(--primary)}
    .day .badge{
      font-size:clamp(.75rem,2.5vw,.9rem);
      padding:4px 8px;border-radius:10px;background:rgba(52,211,153,.15);
      border:1px solid rgba(52,211,153,.3);color:#a7f3d0;margin-bottom:4px;
    }

    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;z-index:40
    }
    .modal{
      width:min(580px,94vw);background:var(--panel);
      border:1px solid rgba(255,255,255,.08);border-radius:18px;
      box-shadow:var(--shadow);overflow:hidden
    }
    .modal header{background:var(--panel-2)}
    .modal .content{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .footer{display:flex;justify-content:space-between;gap:10px;padding:12px 16px}

    /* Ø´Ø±ÙŠØ· ØªÙ†Ø¨ÙŠÙ‡ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    .install-bar{
      position:fixed;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      max-width:640px;
      width:calc(100% - 20px);
      background:var(--panel-2);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:30;
      font-size:.85rem;
    }
    .install-text{
      flex:1;
      color:var(--muted);
      line-height:1.5;
    }

    /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ PWA */
    @media (display-mode: standalone), (display-mode: fullscreen){
      #installBanner{display:none !important;}
    }

    /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ØµÙØ­Ø© Ø£ÙÙ‚ÙŠØ© + Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø· */
    @media print{
      @page { size: A4 landscape; margin: 10mm; }
      body{background:#fff;color:#000;font-size:11px}
      header, footer, #setup, #calendar, #installBanner, #loginBg, #confirmBg{display:none !important}
      #printArea{display:block !important}
    }

    footer{margin:24px auto;max-width:1100px;padding:0 16px 24px;color:var(--muted);text-align:center}
  </style>
</head>
<!-- index.html â€“ Ø§Ù„Ø¬Ø²Ø¡ 2/3 -->
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand">
        <div class="logo">â±ï¸</div>
        <h1 id="appTitle">KeFo Work Hours</h1>
      </div>

      <div class="summary">
        <div class="chip"><span id="lblMonthSum">Hours</span> : <b id="sum-month">0:00</b></div>
        <div class="chip"><span id="lblOT">OT</span> : <b id="sum-ot">0:00</b></div>
        <div class="chip"><span id="lblVisitors">Visitors (24h)</span> : <b id="visitors24h">0</b></div>
        <div class="chip" style="gap:6px">
          <span id="lblLang">Language</span> :
          <select id="langSwitcher" class="btn">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          </select>
        </div>
        <button class="btn" id="btnPrint">ğŸ–¨ï¸ <span id="lblPrint">PDF</span></button>
        <button class="btn" id="btnAbout"><span id="lblAbout">About us</span></button>
        <button class="btn" id="btnEditPolicy">âš™ï¸ <span id="lblSettings">Settings</span></button>
        <button class="btn" id="btnSwitchDevice"><span id="lblSwitchDevice">Switch device</span></button>
        <button class="btn btn-danger" id="btnResetAll">ğŸ—‘ï¸ <span id="lblReset">Reset</span></button>
      </div>
    </div>
  </header>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù‚ØªØ±Ø§Ø­ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø¬ÙˆØ§Ù„ -->
  <div id="installBanner" class="install-bar" hidden>
    <div class="install-text" id="installText"></div>
    <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
      <button class="btn btn-primary" id="btnInstallApp">Install</button>
      <button class="btn" id="btnInstallClose">âœ–</button>
    </div>
  </div>

  <main>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ -->
    <section id="setup" class="panel" hidden>
      <h2 id="setupTitle" style="margin-top:0">Quick setup</h2>

      <!-- Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ (ÙƒÙˆØ¯ KeFo) Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
      <div class="q">
        <label id="lblMyAccount">Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ (KeFo Code)</label>
        <input id="myAccountCode" type="text" disabled value="â€”" />
        <div id="hintMyAccount" class="hint">
          Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.
        </div>
      </div>

      <div class="q">
        <label id="qOfficial">Official daily work hours</label>
        <input id="officialHours" type="number" min="1" max="24" step="0.25" placeholder="8" />
        <div id="hintOfficial" class="hint">This value will be saved.</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" id="setupSkip">Skip</button>
        <button class="btn btn-primary" id="setupSave">Save</button>
      </div>
    </section>

    <!-- Ø§Ù„ØªÙ‚ÙˆÙŠÙ… -->
    <section id="calendar" class="panel" hidden>
      <div class="month-header">
        <div class="nav"><button class="btn" id="prevMonth">â—€</button></div>
        <div class="month-title" id="calTitle">â€”</div>
        <div class="nav"><button class="btn" id="nextMonth">â–¶</button></div>
      </div>
      <div class="cal-grid" id="dow"></div>
      <div class="cal-grid" id="days"></div>
    </section>

    <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø¬Ø¯ÙˆÙ„ Ø£ÙÙ‚ÙŠ Ù…Ù†Ø¸Ù…) -->
    <section id="printArea" style="display:none">
      <h2 id="reportTitle" style="margin:0 0 8px 0"></h2>
      <table id="reportTable" style="width:100%;border-collapse:collapse;font-family:system-ui">
        <thead>
          <tr>
            <th id="thStartDate" style="border:1px solid #777;padding:4px;text-align:center">Startdatum</th>
            <th id="thStartTime" style="border:1px solid #777;padding:4px;text-align:center">Startzeit</th>
            <th id="thEndDate"   style="border:1px solid #777;padding:4px;text-align:center">Enddatum</th>
            <th id="thEndTime"   style="border:1px solid #777;padding:4px;text-align:center">Endzeit</th>
            <th id="thDuration"  style="border:1px solid #777;padding:4px;text-align:center">Dauer</th>
            <th id="thWorked"    style="border:1px solid #777;padding:4px;text-align:center">Arbeitszeit</th>
            <th id="thBreak"     style="border:1px solid #777;padding:4px;text-align:center">Pause</th>
            <th id="thOT"        style="border:1px solid #777;padding:4px;text-align:center">Ãœberstunden</th>
          </tr>
        </thead>
        <tbody id="reportBody"></tbody>
        <tfoot>
          <tr>
            <th id="thTotal" style="border:1px solid #777;padding:4px;text-align:center">Gesamt</th>
            <th colspan="4" style="border:1px solid #777;padding:4px;text-align:center"></th>
            <th id="tdSumWorked" style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
            <th id="tdSumBreak"  style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
            <th id="tdSumOT"     style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
          </tr>
        </tfoot>
      </table>
      <div style="margin-top:8px;font-size:.9rem">Â© <span id="year"></span> KeFo.tech</div>
    </section>
  </main>

  <footer>
    Â© <span id="yearFoot"></span> KeFo.tech â€” <span id="rights">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
  </footer>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ÙŠÙˆÙ… -->
  <div class="modal-backdrop" id="modalBg" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="wrap" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800" id="modalTitle">â€”</div>
        <button class="btn" id="modalClose">âœ–</button>
      </header>
      <div class="content">
        <div class="row">
          <div class="q"><label id="lblStart">Start</label><input id="inStart" type="time" /></div>
          <div class="q"><label id="lblEnd">End</label><input id="inEnd" type="time" /></div>
        </div>
        <div class="row">
          <div class="q"><label id="lblBreak">Break</label><input id="inBreak" type="number" min="0" step="5" placeholder="30" /></div>
          <div class="q"><label id="lblTotal">Total</label><input id="inResult" type="text" disabled value="0:00" /></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="btnDeleteDay">ğŸ—‘ï¸ <span id="lblDeleteDay">Delete day</span></button>
        <div style="display:flex;gap:10px">
          <button class="btn" id="btnNow">â±ï¸ <span id="lblNow">Now</span></button>
          <button class="btn btn-primary" id="btnSaveDay">ğŸ’¾ <span id="lblSave">Save</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙˆØ¯ KeFo -->
  <div class="modal-backdrop" id="loginBg" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="wrap" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800" id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <button class="btn" id="loginClose">âœ–</button>
      </header>
      <div class="content">
        <p id="loginDesc" class="hint" style="margin-bottom:10px">
          Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ KeFo Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŒ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ù„ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ù‡Ø²ØªÙƒ.
        </p>
        <div class="q">
          <label id="loginCodeLabel">ÙƒÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <input id="loginCodeInput" type="text" placeholder="KeFo123456" />
          <div class="hint" id="loginHint">Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†ØŒ Ø³ØªØ­ØªØ§Ø¬Ù‡ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:8px">
          <button class="btn" id="btnCreateUser">ğŸ†• <span id="lblCreateUser">Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</span></button>
          <button class="btn btn-primary" id="btnLoginCode">ğŸ” <span id="lblLogin">Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙƒÙˆØ¯</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÙƒÙŠØ¯ (Reset) -->
  <div class="modal-backdrop" id="confirmBg" role="alertdialog" aria-modal="true">
    <div class="modal">
      <header class="wrap" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800" id="confirmTitle">ØªØ£ÙƒÙŠØ¯</div>
        <button class="btn" id="confirmClose">âœ–</button>
      </header>
      <div class="content">
        <p id="confirmMessage" class="hint"></p>
      </div>
      <div class="footer" style="justify-content:flex-end;gap:10px">
        <button class="btn" id="confirmNo">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" id="confirmYes">Ù†Ø¹Ù…</button>
      </div>
    </div>
  </div>
    <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    /* ========= ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†ØµÙˆØµ (3 Ù„ØºØ§Øª) ========= */
    const i18n = {
      de:{
        installAndroidText:'Installiere die App, um alle Funktionen nutzen zu kÃ¶nnen.',
        installIosText:'Um die App zu installieren: Safari Ã¶ffnen â†’ Teilen â†’ â€Zum Home-Bildschirm hinzufÃ¼genâ€œ.',
        installBtn:'App installieren',
        rights:'Alle Rechte vorbehalten',

        appTitle:'Arbeitszeitrechner',
        monthSum:'Stunden dieses Monats',
        overtime:'Ãœberstunden',
        visitors24:'Besucher (letzte 24h)',
        language:'Sprache',
        settings:'Einstellungen',
        reset:'ZurÃ¼cksetzen',
        print:'PDF-Bericht',
        about:'Ãœber uns',
        switchDevice:'GerÃ¤t wechseln',

        setupTitle:'Schnelle Einrichtung',
        qOfficial:'Offizielle tÃ¤gliche Arbeitszeit (Stunden)',
        hintOfficial:'Diese Einstellung wird gespeichert.',
        skip:'Ãœberspringen',
        next:'Weiter',

        weekdays:['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'],

        start:'Startzeit',
        end:'Endzeit',
        break:'Pause (Minuten)',
        total:'Tagessumme',

        deleteDay:'Tag lÃ¶schen',
        now:'Jetzt',
        save:'Speichern',
        noData:'â€”',

        reportTitle:'Monatsbericht',
        thStartDate:'Startdatum',
        thStartTime:'Startzeit',
        thEndDate:'Enddatum',
        thEndTime:'Endzeit',
        thDuration:'Dauer',
        thWorked:'Arbeitszeit',
        thBreak:'Pause',
        thOT:'Ãœberstunden',
        thTotal:'Gesamt',

        loginTitle:'Anmeldung',
        loginDesc:'Mit KeFo-Code anmelden oder neuen Code erstellen.',
        loginCodeLabel:'KeFo-Anmeldecode',
        loginHint:'Code gut aufbewahren.',
        loginCreate:'Neuen Code erstellen',
        loginBtn:'Mit Code anmelden',
        loginCodeMsg:'Dein Login-Code:',
        loginEmpty:'Bitte Code eingeben.',
        loginNotFound:'Code nicht gefunden.',

        myAccountLabel:'Meine KeFo-Kontonummer',
        myAccountHint:'Diesen Code auf neuem GerÃ¤t eingeben.',
        switchDeviceHint:'Nutze diesen Code auf deinem neuen GerÃ¤t, um deine Daten zu laden.',

        resetConfirmTitle:'ZurÃ¼cksetzen bestÃ¤tigen',
        resetConfirmText:'Alle Daten lÃ¶schen?',
        btnYes:'Ja',
        btnNo:'Nein'
      },

      en:{
        installAndroidText:'We recommend installing the app to use all features.',
        installIosText:'To install: open this site in Safari â†’ Share â†’ Add to Home Screen.',
        installBtn:'Install app',
        rights:'All rights reserved',

        appTitle:'Work Hours Calculator',
        monthSum:'Hours this month',
        overtime:'Overtime',
        visitors24:'Visitors (24h)',
        language:'Language',
        settings:'Settings',
        reset:'Reset',
        print:'PDF Report',
        about:'About us',
        switchDevice:'Switch device',

        setupTitle:'Quick setup',
        qOfficial:'Official daily work hours',
        hintOfficial:'This value will be saved.',
        skip:'Skip',
        next:'Next',

        weekdays:['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'],

        start:'Start',
        end:'End',
        break:'Break (min)',
        total:'Total',

        deleteDay:'Delete day',
        now:'Now',
        save:'Save',
        noData:'â€”',

        reportTitle:'Monthly report',
        thStartDate:'Start date',
        thStartTime:'Start time',
        thEndDate:'End date',
        thEndTime:'End time',
        thDuration:'Duration',
        thWorked:'Worked',
        thBreak:'Break',
        thOT:'Overtime',
        thTotal:'Total',

        loginTitle:'Login',
        loginDesc:'Enter your KeFo Code or create a new one.',
        loginCodeLabel:'KeFo login code',
        loginHint:'Keep your code safe.',
        loginCreate:'Create new code',
        loginBtn:'Login',
        loginCodeMsg:'Your login code:',
        loginEmpty:'Please enter your code.',
        loginNotFound:'Code not found.',

        myAccountLabel:'My KeFo account number',
        myAccountHint:'Use this code on your new device.',
        switchDeviceHint:'Use this code on your new device to load your data.',

        resetConfirmTitle:'Confirm reset',
        resetConfirmText:'Delete all data?',
        btnYes:'Yes',
        btnNo:'Cancel'
      },

      ar:{
        installAndroidText:'Ù†Ù†ØµØ­Ùƒ Ø¨ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª.',
        installIosText:'Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Safari â†’ Ù…Ø´Ø§Ø±ÙƒØ© â†’ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.',
        installBtn:'ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
        rights:'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©',

        appTitle:'Ø­Ø§Ø³Ø¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„',
        monthSum:'Ø³Ø§Ø¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
        overtime:'Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ',
        visitors24:'Ø§Ù„Ø²Ø§Ø¦Ø±ÙˆÙ† Ø¢Ø®Ø± Ù¢Ù¤ Ø³Ø§Ø¹Ø©',
        language:'Ø§Ù„Ù„ØºØ©',
        settings:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
        reset:'ØªØµÙÙŠØ±',
        print:'ØªÙ‚Ø±ÙŠØ± PDF',
        about:'Ù…Ù† Ù†Ø­Ù†',
        switchDevice:'ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²',

        setupTitle:'Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø±ÙŠØ¹',
        qOfficial:'Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ©',
        hintOfficial:'Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.',
        skip:'ØªØ®Ø·ÙŠ',
        next:'Ø­ÙØ¸',

        weekdays:['Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯'],

        start:'Ø¨Ø¯Ø§ÙŠØ©',
        end:'Ù†Ù‡Ø§ÙŠØ©',
        break:'Ø§Ø³ØªØ±Ø§Ø­Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)',
        total:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',

        deleteDay:'Ø­Ø°Ù Ø§Ù„ÙŠÙˆÙ…',
        now:'Ø§Ù„Ø¢Ù†',
        save:'Ø­ÙØ¸',
        noData:'â€”',

        reportTitle:'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±',
        thStartDate:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        thStartTime:'ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        thEndDate:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        thEndTime:'ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        thDuration:'Ø§Ù„Ù…Ø¯Ø©',
        thWorked:'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„',
        thBreak:'Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©',
        thOT:'Ø¥Ø¶Ø§ÙÙŠ',
        thTotal:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',

        loginTitle:'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        loginDesc:'Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ KeFo Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯.',
        loginCodeLabel:'ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        loginHint:'Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†.',
        loginCreate:'Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯',
        loginBtn:'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        loginCodeMsg:'Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:',
        loginEmpty:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯.',
        loginNotFound:'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.',

        myAccountLabel:'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ÙŠ KeFo',
        myAccountHint:'Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯.',
        switchDeviceHint:'Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.',

        resetConfirmTitle:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙÙŠØ±',
        resetConfirmText:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ',
        btnYes:'Ù†Ø¹Ù…',
        btnNo:'Ø¥Ù„ØºØ§Ø¡'
      }
    };

    /* Ø£Ø¯ÙˆØ§Øª */
    const $  = s=>document.querySelector(s);
    const pad = n=>String(n).padStart(2,'0');
    const fmtHM = m=>{m=Math.max(0,Math.round(m||0));return `${Math.floor(m/60)}:${pad(m%60)}`};
    const toKey=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;

    /* LocalStorage */
    const store={
      get hours(){return parseFloat(localStorage.getItem('officialDailyHours')||'0')||0},
      set hours(v){localStorage.setItem('officialDailyHours',String(v))},

      get logs(){return JSON.parse(localStorage.getItem('workLogs')||'{}')},
      set logs(o){localStorage.setItem('workLogs',JSON.stringify(o))},

      get lang(){return localStorage.getItem('lang')||autoLang()},
      set lang(v){localStorage.setItem('lang',v)},

      reset(){localStorage.clear()}
    };

    /* Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© */
    let view=new Date();
    let activeKey=null;
    let db=null;
    let userCode=null;
    let deferredPrompt=null;
    let confirmResolver=null;

    let installDismissed = localStorage.getItem('installDismissed') === '1';
    let appInstalled      = localStorage.getItem('appInstalled') === '1';

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyAMVnS-oDUU905EtHx-J8NTRNwW5xr3yMg",
      authDomain: "kefo-work-hours.firebaseapp.com",
      projectId: "kefo-work-hours",
      storageBucket: "kefo-work-hours.firebasestorage.app",
      messagingSenderId: "345952050958",
      appId: "1:345952050958:web:170e06f285cf181b1a815f"
    };

    function autoLang(){
      const nav=(navigator.language||'en').toLowerCase();
      if(nav.startsWith('ar')) return 'ar';
      if(nav.startsWith('de')) return 'de';
      return 'en';
    }

    /* ========= Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªØ«Ø¨ÙŠØª ========= */
    function isIos(){ return /iphone|ipad|ipod/i.test(navigator.userAgent); }
    function isMobile(){ return /android|iphone|ipad|ipod/i.test(navigator.userAgent); }
    function isStandalone(){
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    }

    function setupInstallBanner(){
      const banner = $('#installBanner');

      // Ù„Ø§ ØªØ¸Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø¥Ø°Ø§ ØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ù‹Ø§
      if(isStandalone() || appInstalled || installDismissed){
        banner.hidden = true;
        return;
      }

      const t=i18n[store.lang];

      if(isIos()){
        $('#installText').textContent = t.installIosText;
        $('#btnInstallApp').textContent = t.installBtn;
        banner.hidden = false;
      }
    }

    window.addEventListener('beforeinstallprompt', (e)=>{
      if(!isMobile() || isIos() || isStandalone() || installDismissed || appInstalled) return;
      e.preventDefault();
      deferredPrompt = e;

      const t=i18n[store.lang];
      $('#installText').textContent = t.installAndroidText;
      $('#btnInstallApp').textContent = t.installBtn;

      $('#installBanner').hidden = false;
    });

    window.addEventListener('appinstalled', ()=>{
      appInstalled = true;
      installDismissed = true;
      localStorage.setItem('appInstalled','1');
      localStorage.setItem('installDismissed','1');
      $('#installBanner').hidden = true;
    });

    /* Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    document.addEventListener('click', e=>{
      if(e.target.id === 'btnInstallClose'){
        $('#installBanner').hidden = true;
        installDismissed = true;
        localStorage.setItem('installDismissed','1');
      }
      if(e.target.id === 'btnInstallApp'){
        if(deferredPrompt){
          deferredPrompt.prompt();
        }
      }
    });

    /* ========= ØªØ±Ø¬Ù…Ø§Øª UI ========= */
    function applyLang(){
      const t=i18n[store.lang];

      document.documentElement.lang=store.lang;
      document.documentElement.dir=store.lang==='ar'?'rtl':'ltr';

      $('#appTitle').textContent     = t.appTitle;
      $('#lblMonthSum').textContent  = t.monthSum;
      $('#lblOT').textContent        = t.overtime;
      $('#lblVisitors').textContent  = t.visitors24;
      $('#lblLang').textContent      = t.language;
      $('#lblPrint').textContent     = t.print;
      $('#lblAbout').textContent     = t.about;
      $('#lblSettings').textContent  = t.settings;
      $('#lblReset').textContent     = t.reset;
      $('#lblSwitchDevice').textContent = t.switchDevice;

      $('#setupTitle').textContent   = t.setupTitle;
      $('#qOfficial').textContent    = t.qOfficial;
      $('#hintOfficial').textContent = t.hintOfficial;
      $('#setupSkip').textContent    = t.skip;
      $('#setupSave').textContent    = t.next;

      $('#lblMyAccount').textContent = t.myAccountLabel;
      $('#hintMyAccount').textContent= t.myAccountHint;

      $('#lblStart').textContent     = t.start;
      $('#lblEnd').textContent       = t.end;
      $('#lblBreak').textContent     = t.break;
      $('#lblTotal').textContent     = t.total;
      $('#lblDeleteDay').textContent = t.deleteDay;
      $('#lblNow').textContent       = t.now;
      $('#lblSave').textContent      = t.save;

      $('#rights').textContent       = t.rights;

      $('#thStartDate').textContent  = t.thStartDate;
      $('#thStartTime').textContent  = t.thStartTime;
      $('#thEndDate').textContent    = t.thEndDate;
      $('#thEndTime').textContent    = t.thEndTime;
      $('#thDuration').textContent   = t.thDuration;
      $('#thWorked').textContent     = t.thWorked;
      $('#thBreak').textContent      = t.thBreak;
      $('#thOT').textContent         = t.thOT;
      $('#thTotal').textContent      = t.thTotal;

      $('#loginTitle').textContent   = t.loginTitle;
      $('#loginDesc').textContent    = t.loginDesc;
      $('#loginCodeLabel').textContent= t.loginCodeLabel;
      $('#loginHint').textContent    = t.loginHint;
      $('#lblCreateUser').textContent= t.loginCreate;
      $('#lblLogin').textContent= t.loginBtn;

      renderWeekdays();
      renderCalendarTitle();
      renderCalendar();
    }

    /* Ø§Ù„ØªÙ‚ÙˆÙŠÙ… */
    function renderWeekdays(){
      const t=i18n[store.lang];
      const dow=$('#dow'); dow.innerHTML='';
      for(const w of t.weekdays){
        const el=document.createElement('div');
        el.className='dow';
        el.textContent=w;
        dow.appendChild(el);
      }
    }
    function renderCalendarTitle(){
      $('#calTitle').textContent=
        new Intl.DateTimeFormat(store.lang,{month:'long',year:'numeric'}).format(view);
    }
    function renderCalendar(){
      const y=view.getFullYear(), m=view.getMonth();
      const first=new Date(y,m,1), last=new Date(y,m+1,0);
      const firstDow=(first.getDay()+6)%7;
      const daysEl=$('#days'); daysEl.innerHTML='';

      const logs=store.logs;

      for(let i=0;i<firstDow;i++){
        const cell=document.createElement('div');
        cell.className='day disabled';
        daysEl.appendChild(cell);
      }

      for(let d=1; d<=last.getDate(); d++){
        const key=toKey(y,m,d);
        const cell=document.createElement('div');
        cell.className='day';

        const num=document.createElement('div');
        num.className='dnum';
        num.textContent=d;
        cell.appendChild(num);

        const badge=document.createElement('div');
        badge.className='badge';
        badge.textContent=logs[key]?fmtHM(logs[key].worked):(i18n[store.lang]).noData;
        cell.appendChild(badge);

        const btn=document.createElement('button');
        btn.className='edit';
        btn.textContent='âœ';
        btn.onclick=()=>openDayModal(key);
        cell.appendChild(btn);

        daysEl.appendChild(cell);
      }
    }

    function updateSummary(){
      const y=view.getFullYear(), m=view.getMonth();
      const logs=store.logs; let total=0, ot=0;

      for(const k in logs){
        const [yy,mm]=k.split('-').map(Number);
        if(yy===y && mm===m+1){
          const w=logs[k].worked||0;
          total+=w;
          ot+=Math.max(0, w - store.hours*60);
        }
      }
      $('#sum-month').textContent=fmtHM(total);
      $('#sum-ot').textContent   =fmtHM(ot);
    }

    /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ÙŠÙˆÙ… */
    function openDayModal(key){
      activeKey=key;
      const log=store.logs[key]||{};
      const dt=new Date(key);
      $('#modalTitle').textContent=
        new Intl.DateTimeFormat(store.lang,{weekday:'long',day:'numeric',month:'long'}).format(dt);

      $('#inStart').value=log.start||'';
      $('#inEnd').value  =log.end||'';
      $('#inBreak').value=log.break||'';
      $('#inResult').value=log.worked?fmtHM(log.worked):'0:00';
      $('#modalBg').style.display='flex';
    }
    function closeModal(){ $('#modalBg').style.display='none'; }

    function computeDuration(start,end){
      if(!start||!end) return 0;
      const [sh,sm]=start.split(':').map(Number);
      const [eh,em]=end.split(':').map(Number);
      let s=sh*60+sm, e=eh*60+em;
      if(e<s) e+=1440;
      return e-s;
    }
    function computeWorked(start,end,brk){
      return Math.max(0, computeDuration(start,end) - (parseInt(brk)||0));
    }

    /* Ù…Ø²Ø§Ù…Ù†Ø© Firebase */
    async function syncLocalLogsToFirestore(){
      if(!db || !userCode) return;
      const logs = store.logs;
      const userRef = db.collection('users').doc(userCode);
      const batch = db.batch();

      for(const key in logs){
        batch.set(
          userRef.collection('logs').doc(key),
          logs[key],
          {merge:true}
        );
      }
      await batch.commit();
    }

    /* Ø¨Ù†Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF */
    function buildReport(){
      const y=view.getFullYear(), m=view.getMonth();
      const t=i18n[store.lang];

      $('#reportTitle').textContent=
        `${t.reportTitle} â€“ ${new Intl.DateTimeFormat(store.lang,{month:'long',year:'numeric'}).format(view)}`;

      const body=$('#reportBody'); body.innerHTML='';
      const logs=store.logs;

      const last=new Date(y,m+1,0);

      let sumW=0,sumOT=0,sumBr=0;

      for(let d=1; d<=last.getDate(); d++){
        const key=toKey(y,m,d);
        const log=logs[key];
        if(!log) continue;

        const dateStr=new Intl.DateTimeFormat(store.lang,{
          day:'2-digit',month:'2-digit',year:'numeric'
        }).format(new Date(y,m,d));

        const dur=computeDuration(log.start,log.end);
        const w=log.worked||0;
        const br=log.break||0;
        const ot=Math.max(0, w - store.hours*60);

        sumW+=w; sumOT+=ot; sumBr+=br;

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${dateStr}</td>
          <td>${log.start}</td>
          <td>${dateStr}</td>
          <td>${log.end}</td>
          <td>${fmtHM(dur)}</td>
          <td>${fmtHM(w)}</td>
          <td>${fmtHM(br)}</td>
          <td>${fmtHM(ot)}</td>
        `;
        body.appendChild(tr);
      }

      $('#tdSumWorked').textContent=fmtHM(sumW);
      $('#tdSumBreak').textContent =fmtHM(sumBr);
      $('#tdSumOT').textContent    =fmtHM(sumOT);
    }

    /* ÙˆØ§Ø¬Ù‡Ø© */
    function refreshVisibility(){
      const hasHours=store.hours>0;
      $('#setup').hidden  =hasHours;
      $('#calendar').hidden=!hasHours;
    }

    /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ */
    function initSetup(){
      const input=$('#officialHours');
      if(store.hours>0) input.value=store.hours;

      $('#setupSave').onclick=async ()=>{
        const val=parseFloat(input.value);
        if(!val||val<=0||val>24){
          alert('Invalid');
          return;
        }
        store.hours=val;

        if(db && userCode){
          await db.collection('users').doc(userCode).set({
            officialDailyHours:val
          },{merge:true});
        }

        refreshVisibility(); renderCalendar(); updateSummary();
      };

      $('#setupSkip').onclick=async ()=>{
        store.hours=8;
        refreshVisibility();renderCalendar();updateSummary();
      };

      $('#btnEditPolicy').onclick=()=>{
        $('#setup').hidden=false;
        $('#calendar').hidden=true;
      };
    }

    /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© */
    function wireLang(){
      const s=$('#langSwitcher');
      s.value=store.lang;
      s.onchange=async ()=>{
        store.lang=s.value;
        applyLang();
        if(db && userCode){
          await db.collection('users').doc(userCode).set({lang:store.lang},{merge:true});
        }
      };
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚ÙˆÙŠÙ… */
    function wireCalendarNav(){
      $('#prevMonth').onclick=()=>{
        view=new Date(view.getFullYear(),view.getMonth()-1,1);
        renderCalendarTitle(); renderCalendar(); updateSummary();
      };
      $('#nextMonth').onclick=()=>{
        view=new Date(view.getFullYear(),view.getMonth()+1,1);
        renderCalendarTitle(); renderCalendar(); updateSummary();
      };

      $('#btnResetAll').onclick=()=>{
        const t=i18n[store.lang];
        if(confirm(t.resetConfirmText)){
          store.reset();
          localStorage.removeItem('userCode');
          location.reload();
        }
      };

      $('#btnPrint').onclick=()=>{
        buildReport();
        window.print();
      };
    }

    /* ØµÙØ­Ø© Ù…Ù† Ù†Ø­Ù† */
    function wireAbout(){
      $('#btnAbout').onclick=()=>{ window.location.href="about.html"; };
    }

    /* Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
    function wireProtection(){
      document.addEventListener('contextmenu',e=>e.preventDefault());

      let t;  
      document.addEventListener('touchstart',e=>{
        t=setTimeout(()=>e.preventDefault(),600);
      },{passive:false});
      document.addEventListener('touchend',()=>clearTimeout(t));
    }

    /* Firebase init + visits */
    function initFirebase(){
      try{
        firebase.initializeApp(firebaseConfig);
        db=firebase.firestore();

        const visits=db.collection('visits');
        visits.add({
          ts:firebase.firestore.FieldValue.serverTimestamp(),
          agent:navigator.userAgent,
          at:new Date().toISOString()
        });
        visits
          .where('ts','>=',new Date(Date.now()-86400000))
          .get()
          .then(s=>$('#visitors24h').textContent=s.size);
      }catch(e){
        console.log('FB error',e);
      }
    }

    /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    function openLoginModal(){ $('#loginBg').style.display='flex'; }
    function closeLoginModal(){ $('#loginBg').style.display='none'; }

    async function loadUserFromCloud(){
      if(!db || !userCode) return;

      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
      const ref=db.collection('users').doc(userCode);
      const snap=await ref.get();
      if(snap.exists){
        const d=snap.data();
        if(d.officialDailyHours) store.hours=d.officialDailyHours;
        if(d.lang) store.lang=d.lang;
      }

      // Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù…
      const logsSnap=await ref.collection('logs').get();
      const obj={};
      logsSnap.forEach(doc=>obj[doc.id]=doc.data());
      if(Object.keys(obj).length) store.logs=obj;

      applyLang();
      refreshVisibility();
      renderCalendar();
      updateSummary();
    }

    function wireLogin(){
      $('#loginClose').onclick=closeLoginModal;

      $('#btnCreateUser').onclick=async ()=>{
        const code='KeFo'+Math.floor(100000+Math.random()*900000);
        userCode=code;
        localStorage.setItem('userCode',code);

        if(db){
          await db.collection('users').doc(code).set({
            createdAt:new Date().toISOString(),
            officialDailyHours:store.hours||8,
            lang:store.lang
          },{merge:true});
          await syncLocalLogsToFirestore();
        }

        alert(i18n[store.lang].loginCodeMsg+' '+code);
        closeLoginModal();
        loadUserFromCloud();
      };

      $('#btnLoginCode').onclick=async ()=>{
        const code=$('#loginCodeInput').value.trim();
        const t=i18n[store.lang];
        if(!code){ alert(t.loginEmpty); return; }

        if(db){
          const snap=await db.collection('users').doc(code).get();
          if(!snap.exists){
            alert(t.loginNotFound);
            return;
          }
        }

        userCode=code;
        localStorage.setItem('userCode',code);

        closeLoginModal();
        loadUserFromCloud();
      };
    }

    /* Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² */
    function wireAccountButtons(){
      $('#btnSwitchDevice').onclick=()=>{
        const t=i18n[store.lang];
        if(!userCode){
          alert(t.loginEmpty);
          openLoginModal();
          return;
        }
        alert(t.switchDeviceHint+'\n\n'+userCode);
      };
    }

    /* ========= initialize page ========= */
    document.addEventListener('DOMContentLoaded',()=>{
      $('#yearFoot').textContent=new Date().getFullYear();

      if(!localStorage.getItem('lang')) store.lang=autoLang();

      wireLang();
      initSetup();
      wireCalendarNav();
      wireAbout();
      wireLogin();
      wireAccountButtons();
      wireProtection();

      initFirebase();
      setupInstallBanner();
      applyLang();
      refreshVisibility();
      renderCalendar();
      updateSummary();

      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
      const saved=localStorage.getItem('userCode');
      if(saved){
        userCode=saved;
        loadUserFromCloud();
      }else{
        openLoginModal();
      }
    });
  </script>
</body>
</html>


