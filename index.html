<!DOCTYPE html>
<!--
  KeFo Work Hours ‚Äì PWA
  ÿ≠ÿ≥ÿßÿ® ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ŸÖÿπ ÿ™ŸÇŸàŸäŸÖ + PDF ÿ£ŸÅŸÇŸä ŸÖŸÜÿ∏ŸÖ + 3 ŸÑÿ∫ÿßÿ™ + PWA
-->
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeFo Work Hours</title>

  <!-- manifest ŸÑÿ™ÿ∑ÿ®ŸäŸÇ PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <!-- ŸÑŸàŸÜ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿπŸÜÿØ ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™ -->
  <meta name="theme-color" content="#0f172a">
  <!-- ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ™ÿ®ŸàŸäÿ® -->
  <link rel="icon" href="icons/icon-512.png">

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937;
      --muted:#9ca3af; --text:#e5e7eb;
      --primary:#22d3ee; --accent:#a78bfa; --success:#34d399;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}

    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.15), transparent),
        radial-gradient(800px 400px at 10% 110%, rgba(34,211,238,.12), transparent),
        var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:clamp(10px,3vw,16px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:clamp(6px,2vw,12px);flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      color:#0b1020;font-weight:800;box-shadow:var(--shadow)
    }
    h1{font-size:1.25rem;margin:0;font-weight:800}

    .summary{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .chip{
      background:var(--panel-2);border:1px solid rgba(255,255,255,.06);
      padding:6px clamp(8px,2vw,12px);border-radius:999px;
      font-size:clamp(.78rem,2.4vw,.92rem);
      display:flex;gap:6px;align-items:center;min-height:32px
    }
    .chip b{color:#fff}

    .btn{
      appearance:none;border:0;background:var(--panel-2);color:var(--text);
      padding:8px 12px;border-radius:12px;cursor:pointer;
      box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.06);
      font-weight:700;transition:.2s transform,.2s opacity
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#0b1020}
    .btn-danger{background:linear-gradient(135deg,#fb7185,#fbbf24);color:#0b1020}

    main{max-width:1100px;margin:clamp(12px,3.5vw,24px) auto;padding:clamp(10px,3vw,16px)}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:clamp(12px,3vw,16px);overflow:hidden
    }

    /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØ */
    #setup{max-width:680px;margin:56px auto}
    .q{display:flex;flex-direction:column;gap:10px;margin:14px 0}
    label{color:#cbd5e1;font-weight:700}
    input[type="number"],input[type="time"],select{
      width:100%;background:var(--panel);border:1px solid rgba(255,255,255,.08);
      color:var(--text);padding:12px 14px;border-radius:12px;outline:none
    }
    .hint{color:var(--muted);font-size:.9rem}

    /* ÿßŸÑÿ™ŸÇŸàŸäŸÖ */
    .month-header{
      display:grid;grid-template-columns:1fr auto 1fr;
      align-items:center;margin-bottom:10px
    }
    .month-title{
      text-align:center;font-size:clamp(1.05rem,4vw,1.3rem);font-weight:900
    }
    .nav{display:flex;gap:8px}

    .cal-grid{
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:6px;width:100%
    }
    .dow{
      text-align:center;font-weight:700;color:var(--muted);
      font-size:clamp(.8rem,2.2vw,.95rem);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      line-height:1.5;padding:8px 0;
    }

    .day{
      background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;
      display:flex;flex-direction:column;align-items:center;justify-content:space-between;
      min-height:clamp(70px,13vw,100px);padding:6px;position:relative;
    }
    .day.disabled{opacity:.35;filter:grayscale(30%)}
    .today{outline:2px dashed var(--primary);outline-offset:2px}
    .day .dnum{font-weight:700;color:#fff;font-size:clamp(.9rem,2.8vw,1rem);margin-top:4px}
    .day .edit{
      position:absolute;top:6px;right:6px;background:none;border:none;color:var(--muted);
      cursor:pointer;font-size:.9rem;line-height:1;padding:2px 4px;border-radius:8px;
      transition:.2s;user-select:none;
    }
    .day .edit:hover{color:var(--primary)}
    .day .badge{
      font-size:clamp(.75rem,2.5vw,.9rem);
      padding:4px 8px;border-radius:10px;background:rgba(52,211,153,.15);
      border:1px solid rgba(52,211,153,.3);color:#a7f3d0;margin-bottom:4px;
    }

    /* ÿßŸÑŸÖŸàÿØÿßŸÑ */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;z-index:40
    }
    .modal{
      width:min(580px,94vw);background:var(--panel);
      border:1px solid rgba(255,255,255,.08);border-radius:18px;
      box-shadow:var(--shadow);overflow:hidden
    }
    .modal header{background:var(--panel-2)}
    .modal .content{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .footer{display:flex;justify-content:space-between;gap:10px;padding:12px 16px}

    /* ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ÿµŸÅÿ≠ÿ© ÿ£ŸÅŸÇŸäÿ© + ÿ¨ÿØŸàŸÑ ŸÅŸÇÿ∑ */
    @media print{
      @page { size: A4 landscape; margin: 10mm; }
      body{background:#fff;color:#000;font-size:11px}
      header, footer, #setup, #calendar{display:none !important}
      #printArea{display:block !important}
    }

    footer{margin:24px auto;max-width:1100px;padding:0 16px 24px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand">
        <div class="logo">‚è±Ô∏è</div>
        <h1 id="appTitle">KeFo Work Hours</h1>
      </div>

      <div class="summary">
        <div class="chip"><span id="lblMonthSum">Hours</span> : <b id="sum-month">0:00</b></div>
        <div class="chip"><span id="lblOT">OT</span> : <b id="sum-ot">0:00</b></div>
        <div class="chip" style="gap:6px">
          <span id="lblLang">Language</span> :
          <select id="langSwitcher" class="btn">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          </select>
        </div>
        <button class="btn" id="btnPrint">üñ®Ô∏è <span id="lblPrint">PDF</span></button>
        <button class="btn" id="btnEditPolicy">‚öôÔ∏è <span id="lblSettings">Settings</span></button>
        <button class="btn btn-danger" id="btnResetAll">üóëÔ∏è <span id="lblReset">Reset</span></button>
      </div>
    </div>
  </header>

  <main>
    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØ -->
    <section id="setup" class="panel" hidden>
      <h2 id="setupTitle" style="margin-top:0">Quick setup</h2>
      <div class="q">
        <label id="qOfficial">Official daily work hours</label>
        <input id="officialHours" type="number" min="1" max="24" step="0.25" placeholder="8" />
        <div id="hintOfficial" class="hint">This value will be saved.</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" id="setupSkip">Skip</button>
        <button class="btn btn-primary" id="setupSave">Save</button>
      </div>
    </section>

    <!-- ÿßŸÑÿ™ŸÇŸàŸäŸÖ -->
    <section id="calendar" class="panel" hidden>
      <div class="month-header">
        <div class="nav"><button class="btn" id="prevMonth">‚óÄ</button></div>
        <div class="month-title" id="calTitle">‚Äî</div>
        <div class="nav"><button class="btn" id="nextMonth">‚ñ∂</button></div>
      </div>
      <div class="cal-grid" id="dow"></div>
      <div class="cal-grid" id="days"></div>
    </section>

    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ© (ÿ¨ÿØŸàŸÑ ÿ£ŸÅŸÇŸä ŸÖŸÜÿ∏ŸÖ) -->
    <section id="printArea" style="display:none">
      <h2 id="reportTitle" style="margin:0 0 8px 0"></h2>
      <table id="reportTable" style="width:100%;border-collapse:collapse;font-family:system-ui">
        <thead>
          <tr>
            <th id="thStartDate" style="border:1px solid #777;padding:4px;text-align:center">Startdatum</th>
            <th id="thStartTime" style="border:1px solid #777;padding:4px;text-align:center">Startzeit</th>
            <th id="thEndDate"   style="border:1px solid #777;padding:4px;text-align:center">Enddatum</th>
            <th id="thEndTime"   style="border:1px solid #777;padding:4px;text-align:center">Endzeit</th>
            <th id="thDuration"  style="border:1px solid #777;padding:4px;text-align:center">Dauer</th>
            <th id="thWorked"    style="border:1px solid #777;padding:4px;text-align:center">Arbeitszeit</th>
            <th id="thBreak"     style="border:1px solid #777;padding:4px;text-align:center">Pause</th>
            <th id="thOT"        style="border:1px solid #777;padding:4px;text-align:center">√úberstunden</th>
          </tr>
        </thead>
        <tbody id="reportBody"></tbody>
        <tfoot>
          <tr>
            <th id="thTotal" style="border:1px solid #777;padding:4px;text-align:center">Gesamt</th>
            <th colspan="4" style="border:1px solid #777;padding:4px;text-align:center"></th>
            <th id="tdSumWorked" style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
            <th id="tdSumBreak"  style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
            <th id="tdSumOT"     style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
          </tr>
        </tfoot>
      </table>
      <div style="margin-top:8px;font-size:.9rem">¬© <span id="year"></span> KeFo.tech</div>
    </section>
  </main>

  <footer>
    ¬© <span id="yearFoot"></span> KeFo.tech ‚Äî <span id="rights">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©</span>
  </footer>

  <!-- ŸÖŸàÿØÿßŸÑ ÿßŸÑŸäŸàŸÖ -->
  <div class="modal-backdrop" id="modalBg" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="wrap" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800" id="modalTitle">‚Äî</div>
        <button class="btn" id="modalClose">‚úñ</button>
      </header>
      <div class="content">
        <div class="row">
          <div class="q"><label id="lblStart">Start</label><input id="inStart" type="time" /></div>
          <div class="q"><label id="lblEnd">End</label><input id="inEnd" type="time" /></div>
        </div>
        <div class="row">
          <div class="q"><label id="lblBreak">Break</label><input id="inBreak" type="number" min="0" step="5" placeholder="30" /></div>
          <div class="q"><label id="lblTotal">Total</label><input id="inResult" type="text" disabled value="0:00" /></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="btnDeleteDay">üóëÔ∏è <span id="lblDeleteDay">Delete day</span></button>
        <div style="display:flex;gap:10px">
          <button class="btn" id="btnNow">‚è±Ô∏è <span id="lblNow">Now</span></button>
          <button class="btn btn-primary" id="btnSaveDay">üíæ <span id="lblSave">Save</span></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ========= ÿ™ÿ±ÿ¨ŸÖÿ© ÿßŸÑŸÜÿµŸàÿµ (3 ŸÑÿ∫ÿßÿ™) ========= */
    const i18n = {
      de:{
        appTitle:'Arbeitszeitrechner',
        monthSum:'Stunden dieses Monats',
        overtime:'√úberstunden',
        language:'Sprache',
        settings:'Einstellungen',
        reset:'Zur√ºcksetzen',
        print:'PDF-Bericht',

        setupTitle:'Schnelle Einrichtung',
        qOfficial:'Offizielle t√§gliche Arbeitszeit (Stunden)',
        hintOfficial:'Diese Einstellung wird gespeichert.',
        skip:'√úberspringen',
        next:'Weiter',

        weekdays:['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'],

        start:'Arbeitsbeginn',
        end:'Arbeitsende',
        break:'Pause (Minuten)',
        total:'Tagessumme',

        deleteDay:'Tag l√∂schen',
        now:'Jetzt',
        save:'Speichern',
        noData:'‚Äî',

        errHours:'Bitte eine Zahl zwischen 1 und 24 eingeben.',
        errTimes:'Bitte Beginn und Ende eingeben.',

        reportTitle:'Monatsbericht',
        thStartDate:'Startdatum',
        thStartTime:'Startzeit',
        thEndDate:'Enddatum',
        thEndTime:'Endzeit',
        thDuration:'Dauer',
        thWorked:'Arbeitszeit',
        thBreak:'Pause',
        thOT:'√úberstunden',
        thTotal:'Gesamt',

        rights:'Alle Rechte vorbehalten'
      },
      en:{
        appTitle:'Work Hours Calculator',
        monthSum:'Hours this month',
        overtime:'Overtime',
        language:'Language',
        settings:'Settings',
        reset:'Reset',
        print:'PDF Report',

        setupTitle:'Quick setup',
        qOfficial:'Official daily work hours',
        hintOfficial:'This value will be saved permanently.',
        skip:'Skip',
        next:'Next',

        weekdays:['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'],

        start:'Start time',
        end:'End time',
        break:'Break (minutes)',
        total:'Day total',

        deleteDay:'Delete day',
        now:'Now',
        save:'Save',
        noData:'‚Äî',

        errHours:'Please enter a value between 1 and 24.',
        errTimes:'Please enter start and end times.',

        reportTitle:'Monthly report',
        thStartDate:'Start date',
        thStartTime:'Start time',
        thEndDate:'End date',
        thEndTime:'End time',
        thDuration:'Duration',
        thWorked:'Work time',
        thBreak:'Break',
        thOT:'Overtime',
        thTotal:'Total',

        rights:'All rights reserved'
      },
      ar:{
        appTitle:'ÿ≠ÿßÿ≥Ÿêÿ® ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ',
        monthSum:'ÿ≥ÿßÿπÿßÿ™ Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±',
        overtime:'ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä',
        language:'ÿßŸÑŸÑÿ∫ÿ©',
        settings:'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',
        reset:'ÿ™ÿµŸÅŸäÿ±',
        print:'ÿ™ŸÇÿ±Ÿäÿ± PDF',

        setupTitle:'ÿ•ÿπÿØÿßÿØ ÿ≥ÿ±Ÿäÿπ',
        qOfficial:'ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ±ÿ≥ŸÖŸäÿ© ŸäŸàŸÖŸäŸãÿß (ÿ®ÿßŸÑÿ≥ÿßÿπÿßÿ™)',
        hintOfficial:'ÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿπÿØÿßÿØ ŸàŸäŸÖŸÉŸÜ ÿ™ÿ∫ŸäŸäÿ±Ÿá ŸÑÿßÿ≠ŸÇŸãÿß.',
        skip:'ÿ™ÿÆÿ∑Ÿä',
        next:'ÿßŸÑÿ™ÿßŸÑŸä',

        weekdays:['ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ','ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°','ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°','ÿßŸÑÿÆŸÖŸäÿ≥','ÿßŸÑÿ¨ŸÖÿπÿ©','ÿßŸÑÿ≥ÿ®ÿ™','ÿßŸÑÿ£ÿ≠ÿØ'],

        start:'ÿ®ÿØÿßŸäÿ© ÿßŸÑÿØŸàÿßŸÖ',
        end:'ŸÜŸáÿßŸäÿ© ÿßŸÑÿØŸàÿßŸÖ',
        break:'ŸÖÿØÿ© ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© (ÿ®ÿßŸÑÿØŸÇÿßÿ¶ŸÇ)',
        total:'ÿßŸÑŸÖÿ≠ÿµŸÑÿ© ŸÑŸÑŸäŸàŸÖ',

        deleteDay:'ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸäŸàŸÖ',
        now:'ÿßŸÑÿ¢ŸÜ',
        save:'ÿ≠ŸÅÿ∏',
        noData:'‚Äî',

        errHours:'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿ®ŸäŸÜ 1 Ÿà 24',
        errTimes:'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸàŸÇÿ™ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ©',

        reportTitle:'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±',
        thStartDate:'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©',
        thStartTime:'ŸàŸÇÿ™ ÿßŸÑÿ®ÿØÿßŸäÿ©',
        thEndDate:'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÜŸáÿßŸäÿ©',
        thEndTime:'ŸàŸÇÿ™ ÿßŸÑŸÜŸáÿßŸäÿ©',
        thDuration:'ÿßŸÑŸÖÿØÿ© ÿßŸÑŸÉŸÑŸäÿ©',
        thWorked:'ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ',
        thBreak:'ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©',
        thOT:'ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä',
        thTotal:'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä',

        rights:'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©'
      }
    };

    const $  = s=>document.querySelector(s);
    const pad = n=>String(n).padStart(2,'0');
    const fmtHM = m=>{m=Math.max(0,Math.round(m||0));return `${Math.floor(m/60)}:${pad(m%60)}`};
    const toKey=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;

    const store={
      get hours(){return parseFloat(localStorage.getItem('officialDailyHours')||'0')||0},
      set hours(v){localStorage.setItem('officialDailyHours',String(v))},
      get logs(){return JSON.parse(localStorage.getItem('workLogs')||'{}')},
      set logs(o){localStorage.setItem('workLogs',JSON.stringify(o))},
      get lang(){return localStorage.getItem('lang')||autoLang()},
      set lang(v){localStorage.setItem('lang',v)},
      reset(){localStorage.clear()}
    };

    let view=new Date();
    let activeKey=null;

    function autoLang(){
      const nav=(navigator.language||'en').toLowerCase();
      if(nav.startsWith('ar')) return 'ar';
      if(nav.startsWith('de')) return 'de';
      if(nav.startsWith('en')) return 'en';
      return 'en';
    }

    function applyLang(){
      const lang=store.lang;
      const t=i18n[lang]||i18n.en;
      document.documentElement.lang=lang;
      document.documentElement.dir=(lang==='ar')?'rtl':'ltr';

      $('#appTitle').textContent=t.appTitle;
      $('#lblMonthSum').textContent=t.monthSum;
      $('#lblOT').textContent=t.overtime;
      $('#lblLang').textContent=t.language;
      $('#lblPrint').textContent=t.print;
      $('#lblSettings').textContent=t.settings;
      $('#lblReset').textContent=t.reset;

      $('#setupTitle').textContent=t.setupTitle;
      $('#qOfficial').textContent=t.qOfficial;
      $('#hintOfficial').textContent=t.hintOfficial;
      $('#setupSkip').textContent=t.skip;
      $('#setupSave').textContent=t.next;

      $('#lblStart').textContent=t.start;
      $('#lblEnd').textContent=t.end;
      $('#lblBreak').textContent=t.break;
      $('#lblTotal').textContent=t.total;
      $('#lblDeleteDay').textContent=t.deleteDay;
      $('#lblNow').textContent=t.now;
      $('#lblSave').textContent=t.save;

      $('#rights').textContent=t.rights;

      $('#thStartDate').textContent=t.thStartDate;
      $('#thStartTime').textContent=t.thStartTime;
      $('#thEndDate').textContent  =t.thEndDate;
      $('#thEndTime').textContent  =t.thEndTime;
      $('#thDuration').textContent =t.thDuration;
      $('#thWorked').textContent   =t.thWorked;
      $('#thBreak').textContent    =t.thBreak;
      $('#thOT').textContent       =t.thOT;
      $('#thTotal').textContent    =t.thTotal;

      renderWeekdays();
      renderCalendarTitle();
      renderCalendar();
      updateSummary();
    }

    function renderWeekdays(){
      const t=i18n[store.lang]||i18n.en;
      const dow=$('#dow'); dow.innerHTML='';
      for(const name of t.weekdays){
        const el=document.createElement('div');
        el.className='dow';
        el.textContent=name;
        dow.appendChild(el);
      }
    }

    function renderCalendarTitle(){
      const lang=store.lang;
      $('#calTitle').textContent=
        new Intl.DateTimeFormat(lang,{month:'long',year:'numeric'}).format(view);
    }

    function renderCalendar(){
      const y=view.getFullYear(), m=view.getMonth();
      const first=new Date(y,m,1), last=new Date(y,m+1,0);
      const firstDow=(first.getDay()+6)%7;
      const daysEl=$('#days'); daysEl.innerHTML='';
      for(let i=0;i<firstDow;i++){
        const cell=document.createElement('div');
        cell.className='day disabled';
        daysEl.appendChild(cell);
      }
      const logs=store.logs;
      for(let d=1; d<=last.getDate(); d++){
        const key=toKey(y,m,d);
        const cell=document.createElement('div');
        cell.className='day';

        const num=document.createElement('div');
        num.className='dnum'; num.textContent=d;
        cell.appendChild(num);

        const badge=document.createElement('div');
        badge.className='badge';
        badge.textContent=logs[key]?fmtHM(logs[key].worked):(i18n[store.lang]||i18n.en).noData;
        cell.appendChild(badge);

        const btn=document.createElement('button');
        btn.className='edit'; btn.textContent='‚úé';
        btn.onclick=()=>openDayModal(key);
        cell.appendChild(btn);

        daysEl.appendChild(cell);
      }
    }

    function updateSummary(){
      const y=view.getFullYear(), m=view.getMonth();
      const logs=store.logs; let total=0, ot=0;
      for(const k in logs){
        const [yy,mm]=k.split('-').map(Number);
        if(yy===y && mm===m+1){
          const w=logs[k].worked||0;
          total+=w;
          ot+=Math.max(0, w - store.hours*60);
        }
      }
      $('#sum-month').textContent=fmtHM(total);
      $('#sum-ot').textContent   =fmtHM(ot);
    }

    function openDayModal(key){
      activeKey=key;
      const log=store.logs[key];
      const dt=new Date(key);
      const lang=store.lang;
      $('#modalTitle').textContent=
        new Intl.DateTimeFormat(lang,{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(dt);
      $('#inStart').value=log?.start||'';
      $('#inEnd').value  =log?.end  ||'';
      $('#inBreak').value=log?.break??'';
      $('#inResult').value=log?fmtHM(log.worked):'0:00';
      $('#modalBg').style.display='flex';
    }
    function closeModal(){ $('#modalBg').style.display='none'; activeKey=null; }

    function computeDuration(start,end){
      if(!start||!end) return 0;
      const [sh,sm]=start.split(':').map(Number);
      const [eh,em]=end.split(':').map(Number);
      let s=sh*60+sm, e=eh*60+em;
      if(e<s) e+=1440;
      return e-s;
    }
    function computeWorked(start,end,brk){
      return Math.max(0, computeDuration(start,end) - (parseInt(brk)||0));
    }

    function wireModal(){
      const recalc=()=>{
        $('#inResult').value = fmtHM(
          computeWorked($('#inStart').value,$('#inEnd').value,$('#inBreak').value)
        );
      };
      $('#inStart').addEventListener('input',recalc);
      $('#inEnd').addEventListener('input',recalc);
      $('#inBreak').addEventListener('input',recalc);

      $('#btnSaveDay').onclick=()=>{
        if(!activeKey) return;
        const t=i18n[store.lang]||i18n.en;
        const start=$('#inStart').value;
        const end  =$('#inEnd').value;
        const brk  =$('#inBreak').value||0;
        if(!start||!end){alert(t.errTimes);return;}
        const worked=computeWorked(start,end,brk);
        const logs=store.logs;
        logs[activeKey]={start,end,break:parseInt(brk)||0,worked};
        store.logs=logs;
        renderCalendar(); updateSummary(); closeModal();
      };

      $('#btnDeleteDay').onclick=()=>{
        if(!activeKey) return;
        const logs=store.logs;
        delete logs[activeKey];
        store.logs=logs;
        renderCalendar(); updateSummary(); closeModal();
      };

      $('#modalClose').onclick=closeModal;
      $('#modalBg').addEventListener('click',e=>{ if(e.target.id==='modalBg') closeModal(); });

      $('#btnNow').onclick=()=>{
        const now=new Date();
        $('#inStart').value=`${pad(now.getHours())}:${pad(now.getMinutes())}`;
        $('#inEnd').value  =`${pad((now.getHours()+8)%24)}:${pad(now.getMinutes())}`;
        $('#inBreak').value=30;
        $('#inResult').value=fmtHM(
          computeWorked($('#inStart').value,$('#inEnd').value,$('#inBreak').value)
        );
      };
    }

    function buildReport(){
      const t=i18n[store.lang]||i18n.en;
      const y=view.getFullYear(), m=view.getMonth();
      $('#reportTitle').textContent=
        `${t.reportTitle} ‚Äì ${new Intl.DateTimeFormat(store.lang,{month:'long',year:'numeric'}).format(view)}`;
      $('#year').textContent=y;

      const body=$('#reportBody'); body.innerHTML='';
      const last=new Date(y,m+1,0);
      const logs=store.logs;

      let sumW=0, sumOT=0, sumBreak=0;

      for(let d=1; d<=last.getDate(); d++){
        const key=toKey(y,m,d);
        const log=logs[key];
        if(!log) continue; // ŸÅŸÇÿ∑ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑÿ™Ÿä ÿ™ÿ≠ÿ™ŸàŸä ÿ®ŸäÿßŸÜÿßÿ™

        const startDateStr=new Intl.DateTimeFormat(store.lang,{day:'2-digit',month:'2-digit',year:'numeric'}).format(new Date(y,m,d));
        const endDateStr  =startDateStr; // ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ

        const durationMins=computeDuration(log.start,log.end);          // ÿßŸÑŸÖÿØÿ© ÿßŸÑŸÉŸÑŸäÿ©
        const workedMins  =log.worked||0;                               // ÿ®ÿπÿØ ÿ∑ÿ±ÿ≠ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©
        const breakMins   =log.break||0;
        const otMins      =Math.max(0, workedMins - store.hours*60);

        sumW     += workedMins;
        sumOT    += otMins;
        sumBreak += breakMins;

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${startDateStr}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${log.start||''}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${endDateStr}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${log.end||''}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${fmtHM(durationMins)}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${fmtHM(workedMins)}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${fmtHM(breakMins)}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${fmtHM(otMins)}</td>
        `;
        body.appendChild(tr);
      }

      $('#tdSumWorked').textContent=fmtHM(sumW);
      $('#tdSumBreak').textContent =fmtHM(sumBreak);
      $('#tdSumOT').textContent    =fmtHM(sumOT);
    }

    function refreshVisibility(){
      const hasHours=store.hours>0;
      $('#setup').hidden  =hasHours;
      $('#calendar').hidden=!hasHours;
    }

    function initSetup(){
      const input=$('#officialHours');
      if(store.hours>0) input.value=store.hours;

      $('#setupSave').onclick=()=>{
        const val=parseFloat(input.value);
        const t=i18n[store.lang]||i18n.en;
        if(!val||val<=0||val>24){alert(t.errHours);return;}
        store.hours=val;
        refreshVisibility(); renderCalendar(); updateSummary();
      };
      $('#setupSkip').onclick=()=>{
        store.hours=8;
        refreshVisibility(); renderCalendar(); updateSummary();
      };
      $('#btnEditPolicy').onclick=()=>{
        $('#setup').hidden=false;
        $('#calendar').hidden=true;
      };
    }

    function wireLang(){
      const sel=$('#langSwitcher');
      sel.value=store.lang;
      sel.addEventListener('change',()=>{
        store.lang=sel.value;
        applyLang();
      });
    }

    function wireCalendarNav(){
      $('#prevMonth').onclick=()=>{
        view=new Date(view.getFullYear(),view.getMonth()-1,1);
        renderCalendar(); updateSummary();
      };
      $('#nextMonth').onclick=()=>{
        view=new Date(view.getFullYear(),view.getMonth()+1,1);
        renderCalendar(); updateSummary();
      };
      $('#btnResetAll').onclick=()=>{
        if(confirm('Clear all data?')){
          store.reset(); location.reload();
        }
      };
      $('#btnPrint').onclick=()=>{
        buildReport();
        window.print();
      };
    }

    // ÿ™ÿ≥ÿ¨ŸäŸÑ Service Worker ŸÑŸÄ PWA
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('./sw.js').catch(err=>console.log('SW failed',err));
      });
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const yr=new Date().getFullYear();
      $('#yearFoot').textContent=yr;
      $('#year').textContent=yr;

      if(!localStorage.getItem('lang')) store.lang=autoLang();

      wireLang();
      initSetup();
      wireCalendarNav();
      wireModal();
      applyLang();
      refreshVisibility();
      renderCalendar(); updateSummary();
    });
  </script>
</body>
</html>
