<!DOCTYPE html>
<!--
  KeFo Work Hours â€“ PWA
  Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ ØªÙ‚ÙˆÙŠÙ… + PDF Ø£ÙÙ‚ÙŠ Ù…Ù†Ø¸Ù… + 3 Ù„ØºØ§Øª + PWA + Firebase + Login KeFo + Sync
-->
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeFo Work Hours</title>

  <!-- manifest Ù„ØªØ·Ø¨ÙŠÙ‚ PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <!-- Ù„ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª -->
  <meta name="theme-color" content="#0f172a">
  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
  <link rel="icon" href="icons/icon-512.png">

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937;
      --muted:#9ca3af; --text:#e5e7eb;
      --primary:#22d3ee; --accent:#a78bfa; --success:#34d399;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}

    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.15), transparent),
        radial-gradient(800px 400px at 10% 110%, rgba(34,211,238,.12), transparent),
        var(--bg);
      color:var(--text);
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
    }

    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:clamp(10px,3vw,16px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:clamp(6px,2vw,12px);flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      color:#0b1020;font-weight:800;box-shadow:var(--shadow)
    }
    h1{font-size:1.25rem;margin:0;font-weight:800}

    .summary{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .chip{
      background:var(--panel-2);border:1px solid rgba(255,255,255,.06);
      padding:6px clamp(8px,2vw,12px);border-radius:999px;
      font-size:clamp(.78rem,2.4vw,.92rem);
      display:flex;gap:6px;align-items:center;min-height:32px
    }
    .chip b{color:#fff}

    .btn{
      appearance:none;border:0;background:var(--panel-2);color:var(--text);
      padding:8px 12px;border-radius:12px;cursor:pointer;
      box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.06);
      font-weight:700;transition:.2s transform,.2s opacity
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#0b1020}
    .btn-danger{background:linear-gradient(135deg,#fb7185,#fbbf24);color:#0b1020}

    main{max-width:1100px;margin:clamp(12px,3.5vw,24px) auto;padding:clamp(10px,3vw,16px)}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:clamp(12px,3vw,16px);overflow:hidden
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ */
    #setup{max-width:680px;margin:56px auto}
    .q{display:flex;flex-direction:column;gap:10px;margin:14px 0}
    label{color:#cbd5e1;font-weight:700}
    input[type="number"],input[type="time"],input[type="text"],select{
      width:100%;background:var(--panel);border:1px solid rgba(255,255,255,.08);
      color:var(--text);padding:12px 14px;border-radius:12px;outline:none
    }
    .hint{color:var(--muted);font-size:.9rem}

    /* Ø§Ù„ØªÙ‚ÙˆÙŠÙ… */
    .month-header{
      display:grid;grid-template-columns:1fr auto 1fr;
      align-items:center;margin-bottom:10px
    }
    .month-title{
      text-align:center;font-size:clamp(1.05rem,4vw,1.3rem);font-weight:900
    }
    .nav{display:flex;gap:8px}

    .cal-grid{
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:6px;width:100%
    }
    .dow{
      text-align:center;font-weight:700;color:var(--muted);
      font-size:clamp(.8rem,2.2vw,.95rem);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      line-height:1.5;padding:8px 0;
    }

    .day{
      background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;
      display:flex;flex-direction:column;align-items:center;justify-content:space-between;
      min-height:clamp(70px,13vw,100px);padding:6px;position:relative;
    }
    .day.disabled{opacity:.35;filter:grayscale(30%)}
    .today{outline:2px dashed var(--primary);outline-offset:2px}
    .day .dnum{font-weight:700;color:#fff;font-size:clamp(.9rem,2.8vw,1rem);margin-top:4px}
    .day .edit{
      position:absolute;top:6px;right:6px;background:none;border:none;color:var(--muted);
      cursor:pointer;font-size:.9rem;line-height:1;padding:2px 4px;border-radius:8px;
      transition:.2s;user-select:none;
    }
    .day .edit:hover{color:var(--primary)}
    .day .badge{
      font-size:clamp(.75rem,2.5vw,.9rem);
      padding:4px 8px;border-radius:10px;background:rgba(52,211,153,.15);
      border:1px solid rgba(52,211,153,.3);color:#a7f3d0;margin-bottom:4px;
    }

    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;z-index:40
    }
    .modal{
      width:min(580px,94vw);background:var(--panel);
      border:1px solid rgba(255,255,255,.08);border-radius:18px;
      box-shadow:var(--shadow);overflow:hidden
    }
    .modal header{background:var(--panel-2)}
    .modal .content{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .footer{display:flex;justify-content:space-between;gap:10px;padding:12px 16px}

    /* Ø´Ø±ÙŠØ· ØªÙ†Ø¨ÙŠÙ‡ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    .install-bar{
      position:fixed;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      max-width:640px;
      width:calc(100% - 20px);
      background:var(--panel-2);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:30;
      font-size:.85rem;
    }
    .install-text{
      flex:1;
      color:var(--muted);
      line-height:1.5;
    }

    /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ØµÙØ­Ø© Ø£ÙÙ‚ÙŠØ© + Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø· */
    @media print{
      @page { size: A4 landscape; margin: 10mm; }
      body{background:#fff;color:#000;font-size:11px}
      header, footer, #setup, #calendar, #installBanner, #loginBg, #confirmBg{display:none !important}
      #printArea{display:block !important}
    }

    footer{margin:24px auto;max-width:1100px;padding:0 16px 24px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand">
        <div class="logo">â±ï¸</div>
        <h1 id="appTitle">KeFo Work Hours</h1>
      </div>

      <div class="summary">
        <div class="chip"><span id="lblMonthSum">Hours</span> : <b id="sum-month">0:00</b></div>
        <div class="chip"><span id="lblOT">OT</span> : <b id="sum-ot">0:00</b></div>
        <div class="chip"><span id="lblVisitors">Visitors (24h)</span> : <b id="visitors24h">0</b></div>
        <div class="chip" style="gap:6px">
          <span id="lblLang">Language</span> :
          <select id="langSwitcher" class="btn">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          </select>
        </div>
        <button class="btn" id="btnPrint">ğŸ–¨ï¸ <span id="lblPrint">PDF</span></button>
        <button class="btn" id="btnAbout"><span id="lblAbout">About us</span></button>
        <button class="btn" id="btnEditPolicy">âš™ï¸ <span id="lblSettings">Settings</span></button>
        <button class="btn" id="btnSwitchDevice"><span id="lblSwitchDevice">Switch device</span></button>
        <button class="btn btn-danger" id="btnResetAll">ğŸ—‘ï¸ <span id="lblReset">Reset</span></button>
      </div>
    </div>
  </header>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù‚ØªØ±Ø§Ø­ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø¬ÙˆØ§Ù„ -->
  <div id="installBanner" class="install-bar" hidden>
    <div class="install-text" id="installText"></div>
    <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
      <button class="btn btn-primary" id="btnInstallApp">Install</button>
      <button class="btn" id="btnInstallClose">âœ–</button>
    </div>
  </div>

  <main>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ -->
    <section id="setup" class="panel" hidden>
      <h2 id="setupTitle" style="margin-top:0">Quick setup</h2>

      <!-- Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ (ÙƒÙˆØ¯ KeFo) Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
      <div class="q">
        <label id="lblMyAccount">Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ (KeFo Code)</label>
        <input id="myAccountCode" type="text" disabled value="â€”" />
        <div id="hintMyAccount" class="hint">
          Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.
        </div>
      </div>

      <div class="q">
        <label id="qOfficial">Official daily work hours</label>
        <input id="officialHours" type="number" min="1" max="24" step="0.25" placeholder="8" />
        <div id="hintOfficial" class="hint">This value will be saved.</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" id="setupSkip">Skip</button>
        <button class="btn btn-primary" id="setupSave">Save</button>
      </div>
    </section>

    <!-- Ø§Ù„ØªÙ‚ÙˆÙŠÙ… -->
    <section id="calendar" class="panel" hidden>
      <div class="month-header">
        <div class="nav"><button class="btn" id="prevMonth">â—€</button></div>
        <div class="month-title" id="calTitle">â€”</div>
        <div class="nav"><button class="btn" id="nextMonth">â–¶</button></div>
      </div>
      <div class="cal-grid" id="dow"></div>
      <div class="cal-grid" id="days"></div>
    </section>

    <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø¬Ø¯ÙˆÙ„ Ø£ÙÙ‚ÙŠ Ù…Ù†Ø¸Ù…) -->
    <section id="printArea" style="display:none">
      <h2 id="reportTitle" style="margin:0 0 8px 0"></h2>
      <table id="reportTable" style="width:100%;border-collapse:collapse;font-family:system-ui">
        <thead>
          <tr>
            <th id="thStartDate" style="border:1px solid #777;padding:4px;text-align:center">Startdatum</th>
            <th id="thStartTime" style="border:1px solid #777;padding:4px;text-align:center">Startzeit</th>
            <th id="thEndDate"   style="border:1px solid #777;padding:4px;text-align:center">Enddatum</th>
            <th id="thEndTime"   style="border:1px solid #777;padding:4px;text-align:center">Endzeit</th>
            <th id="thDuration"  style="border:1px solid #777;padding:4px;text-align:center">Dauer</th>
            <th id="thWorked"    style="border:1px solid #777;padding:4px;text-align:center">Arbeitszeit</th>
            <th id="thBreak"     style="border:1px solid #777;padding:4px;text-align:center">Pause</th>
            <th id="thOT"        style="border:1px solid #777;padding:4px;text-align:center">Ãœberstunden</th>
          </tr>
        </thead>
        <tbody id="reportBody"></tbody>
        <tfoot>
          <tr>
            <th id="thTotal" style="border:1px solid #777;padding:4px;text-align:center">Gesamt</th>
            <th colspan="4" style="border:1px solid #777;padding:4px;text-align:center"></th>
            <th id="tdSumWorked" style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
            <th id="tdSumBreak"  style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
            <th id="tdSumOT"     style="border:1px solid #777;padding:4px;text-align:center">0:00</th>
          </tr>
        </tfoot>
      </table>
      <div style="margin-top:8px;font-size:.9rem">Â© <span id="year"></span> KeFo.tech</div>
    </section>
  </main>

  <footer>
    Â© <span id="yearFoot"></span> KeFo.tech â€” <span id="rights">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
  </footer>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ÙŠÙˆÙ… -->
  <div class="modal-backdrop" id="modalBg" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="wrap" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800" id="modalTitle">â€”</div>
        <button class="btn" id="modalClose">âœ–</button>
      </header>
      <div class="content">
        <div class="row">
          <div class="q"><label id="lblStart">Start</label><input id="inStart" type="time" /></div>
          <div class="q"><label id="lblEnd">End</label><input id="inEnd" type="time" /></div>
        </div>
        <div class="row">
          <div class="q"><label id="lblBreak">Break</label><input id="inBreak" type="number" min="0" step="5" placeholder="30" /></div>
          <div class="q"><label id="lblTotal">Total</label><input id="inResult" type="text" disabled value="0:00" /></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="btnDeleteDay">ğŸ—‘ï¸ <span id="lblDeleteDay">Delete day</span></button>
        <div style="display:flex;gap:10px">
          <button class="btn" id="btnNow">â±ï¸ <span id="lblNow">Now</span></button>
          <button class="btn btn-primary" id="btnSaveDay">ğŸ’¾ <span id="lblSave">Save</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙˆØ¯ KeFo -->
  <div class="modal-backdrop" id="loginBg" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="wrap" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800" id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <button class="btn" id="loginClose">âœ–</button>
      </header>
      <div class="content">
        <p id="loginDesc" class="hint" style="margin-bottom:10px">
          Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ KeFo Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŒ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ù„ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ù‡Ø²ØªÙƒ.
        </p>
        <div class="q">
          <label id="loginCodeLabel">ÙƒÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <input id="loginCodeInput" type="text" placeholder="KeFo123456" />
          <div class="hint" id="loginHint">Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†ØŒ Ø³ØªØ­ØªØ§Ø¬Ù‡ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:8px">
          <button class="btn" id="btnCreateUser">ğŸ†• <span id="lblCreateUser">Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</span></button>
          <button class="btn btn-primary" id="btnLoginCode">ğŸ” <span id="lblLogin">Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙƒÙˆØ¯</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÙƒÙŠØ¯ (Reset) -->
  <div class="modal-backdrop" id="confirmBg" role="alertdialog" aria-modal="true">
    <div class="modal">
      <header class="wrap" style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800" id="confirmTitle">ØªØ£ÙƒÙŠØ¯</div>
        <button class="btn" id="confirmClose">âœ–</button>
      </header>
      <div class="content">
        <p id="confirmMessage" class="hint"></p>
      </div>
      <div class="footer" style="justify-content:flex-end;gap:10px">
        <button class="btn" id="confirmNo">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" id="confirmYes">Ù†Ø¹Ù…</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    /* ========= ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†ØµÙˆØµ (3 Ù„ØºØ§Øª) ========= */
    const i18n = {
      de:{
        appTitle:'Arbeitszeitrechner',
        monthSum:'Stunden dieses Monats',
        overtime:'Ãœberstunden',
        visitors24:'Besucher (letzte 24h)',
        language:'Sprache',
        settings:'Einstellungen',
        reset:'ZurÃ¼cksetzen',
        print:'PDF-Bericht',
        about:'Ãœber uns',

        setupTitle:'Schnelle Einrichtung',
        qOfficial:'Offizielle tÃ¤gliche Arbeitszeit (Stunden)',
        hintOfficial:'Diese Einstellung wird gespeichert.',
        skip:'Ãœberspringen',
        next:'Weiter',

        weekdays:['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'],

        start:'Arbeitsbeginn',
        end:'Arbeitsende',
        break:'Pause (Minuten)',
        total:'Tagessumme',

        deleteDay:'Tag lÃ¶schen',
        now:'Jetzt',
        save:'Speichern',
        noData:'â€”',

        errHours:'Bitte eine Zahl zwischen 1 und 24 eingeben.',
        errTimes:'Bitte Beginn und Ende eingeben.',

        reportTitle:'Monatsbericht',
        thStartDate:'Startdatum',
        thStartTime:'Startzeit',
        thEndDate:'Enddatum',
        thEndTime:'Endzeit',
        thDuration:'Dauer',
        thWorked:'Arbeitszeit',
        thBreak:'Pause',
        thOT:'Ãœberstunden',
        thTotal:'Gesamt',

        installAndroidText:'Installiere die App, um alle Funktionen nutzen zu kÃ¶nnen.',
        installIosText:'Um die App zu installieren: Ã–ffne diese Seite in Safari, tippe auf das Teilen-Symbol und wÃ¤hle â€Zum Home-Bildschirm hinzufÃ¼genâ€œ.',
        installBtn:'App installieren',

        rights:'Alle Rechte vorbehalten',

        loginTitle:'Anmeldung',
        loginDesc:'Melde dich mit deinem KeFo-Code an oder erstelle einen neuen Code, um deine Arbeitszeiten auf allen GerÃ¤ten zu synchronisieren.',
        loginCodeLabel:'KeFo-Anmeldecode',
        loginHint:'Bewahre diesen Code sicher auf. Du brauchst ihn, wenn du das GerÃ¤t wechselst.',
        loginCreate:'Neuen Code erstellen',
        loginBtn:'Mit Code anmelden',
        loginCodeMsg:'Dein Anmeldecode:',
        loginEmpty:'Bitte gib deinen Code ein.',
        loginNotFound:'Code nicht gefunden. Bitte Ã¼berprÃ¼fe ihn oder erstelle einen neuen.',

        myAccountLabel:'Meine persÃ¶nliche Kontonummer (KeFo-Code)',
        myAccountHint:'Bewahre diese Nummer auf. Du kannst sie auf einem anderen GerÃ¤t eingeben, um deine Daten zu laden.',
        switchDevice:'GerÃ¤t wechseln',
        switchDeviceHint:'Nutze diesen Code auf deinem neuen GerÃ¤t, um deine Daten zu laden.',

        resetConfirmTitle:'ZurÃ¼cksetzen bestÃ¤tigen',
        resetConfirmText:'MÃ¶chtest du wirklich alle Daten auf diesem GerÃ¤t lÃ¶schen? Dies kann nicht rÃ¼ckgÃ¤ngig gemacht werden.',
        btnYes:'Ja, alles lÃ¶schen',
        btnNo:'Abbrechen'
      },
      en:{
        appTitle:'Work Hours Calculator',
        monthSum:'Hours this month',
        overtime:'Overtime',
        visitors24:'Visitors (last 24h)',
        language:'Language',
        settings:'Settings',
        reset:'Reset',
        print:'PDF Report',
        about:'About us',

        setupTitle:'Quick setup',
        qOfficial:'Official daily work hours',
        hintOfficial:'This value will be saved permanently.',
        skip:'Skip',
        next:'Next',

        weekdays:['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'],

        start:'Start time',
        end:'End time',
        break:'Break (minutes)',
        total:'Day total',

        deleteDay:'Delete day',
        now:'Now',
        save:'Save',
        noData:'â€”',

        errHours:'Please enter a value between 1 and 24.',
        errTimes:'Please enter start and end times.',

        reportTitle:'Monthly report',
        thStartDate:'Start date',
        thStartTime:'Start time',
        thEndDate:'End date',
        thEndTime:'End time',
        thDuration:'Duration',
        thWorked:'Work time',
        thBreak:'Break',
        thOT:'Overtime',
        thTotal:'Total',

        installAndroidText:'We recommend installing the app to use all available features.',
        installIosText:'To install on iPhone: open this site in Safari, tap the Share button, then choose â€œAdd to Home Screenâ€.',
        installBtn:'Install app',

        rights:'All rights reserved',

        loginTitle:'Sign in',
        loginDesc:'Sign in with your KeFo code, or create a new one to sync your working hours across all devices.',
        loginCodeLabel:'KeFo login code',
        loginHint:'Keep this code in a safe place. You will need it when you change device.',
        loginCreate:'Create new code',
        loginBtn:'Sign in with code',
        loginCodeMsg:'Your login code:',
        loginEmpty:'Please enter your code.',
        loginNotFound:'Code not found. Please check it or create a new one.',

        myAccountLabel:'My personal account number (KeFo code)',
        myAccountHint:'Keep this number. Enter it on any new device to load your data.',
        switchDevice:'Switch device',
        switchDeviceHint:'Use this code on your new device to load your data.',

        resetConfirmTitle:'Confirm reset',
        resetConfirmText:'Do you really want to clear all data on this device? This cannot be undone.',
        btnYes:'Yes, clear all',
        btnNo:'Cancel'
      },
      ar:{
        appTitle:'Ø­Ø§Ø³ÙØ¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„',
        monthSum:'Ø³Ø§Ø¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
        overtime:'Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ',
        visitors24:'Ø§Ù„Ø²Ø§Ø¦Ø±ÙˆÙ† Ø¢Ø®Ø± Ù¢Ù¤ Ø³Ø§Ø¹Ø©',
        language:'Ø§Ù„Ù„ØºØ©',
        settings:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
        reset:'ØªØµÙÙŠØ±',
        print:'ØªÙ‚Ø±ÙŠØ± PDF',
        about:'Ù…Ù† Ù†Ø­Ù†',

        setupTitle:'Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø±ÙŠØ¹',
        qOfficial:'Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© ÙŠÙˆÙ…ÙŠÙ‹Ø§ (Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª)',
        hintOfficial:'Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§.',
        skip:'ØªØ®Ø·ÙŠ',
        next:'Ø§Ù„ØªØ§Ù„ÙŠ',

        weekdays:['Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯'],

        start:'Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…',
        end:'Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…',
        break:'Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)',
        total:'Ø§Ù„Ù…Ø­ØµÙ„Ø© Ù„Ù„ÙŠÙˆÙ…',

        deleteDay:'Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…',
        now:'Ø§Ù„Ø¢Ù†',
        save:'Ø­ÙØ¸',
        noData:'â€”',

        errHours:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¨ÙŠÙ† 1 Ùˆ 24',
        errTimes:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©',

        reportTitle:'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±',
        thStartDate:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        thStartTime:'ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        thEndDate:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        thEndTime:'ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
        thDuration:'Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙƒÙ„ÙŠØ©',
        thWorked:'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„',
        thBreak:'Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©',
        thOT:'Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ',
        thTotal:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',

        installAndroidText:'Ù†Ù†ØµØ­Ùƒ Ø¨ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©.',
        installIosText:'Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠÙÙˆÙ†: Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ SafariØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©ØŒ Ø«Ù… Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".',
        installBtn:'ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',

        rights:'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©',

        loginTitle:'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        loginDesc:'Ø§Ø¯Ø®Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ KeFo Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒØŒ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ù„ÙŠØªÙ… Ø­ÙØ¸ Ø³Ø§Ø¹Ø§Øª Ø¹Ù…Ù„Ùƒ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.',
        loginCodeLabel:'ÙƒÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ KeFo',
        loginHint:'Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†ØŒ Ø³ØªØ­ØªØ§Ø¬Ù‡ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨.',
        loginCreate:'Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯',
        loginBtn:'Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙƒÙˆØ¯',
        loginCodeMsg:'ÙƒÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:',
        loginEmpty:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.',
        loginNotFound:'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù†Ù‡ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙƒÙˆØ¯Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.',

        myAccountLabel:'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ (ÙƒÙˆØ¯ KeFo)',
        myAccountHint:'Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.',
        switchDevice:'ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²',
        switchDeviceHint:'Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.',

        resetConfirmTitle:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙÙŠØ±',
        resetConfirmText:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.',
        btnYes:'Ù†Ø¹Ù…ØŒ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„',
        btnNo:'Ø¥Ù„ØºØ§Ø¡'
      }
    };

    const $  = s=>document.querySelector(s);
    const pad = n=>String(n).padStart(2,'0');
    const fmtHM = m=>{m=Math.max(0,Math.round(m||0));return `${Math.floor(m/60)}:${pad(m%60)}`};
    const toKey=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;

    const store={
      get hours(){return parseFloat(localStorage.getItem('officialDailyHours')||'0')||0},
      set hours(v){localStorage.setItem('officialDailyHours',String(v))},
      get logs(){return JSON.parse(localStorage.getItem('workLogs')||'{}')},
      set logs(o){localStorage.setItem('workLogs',JSON.stringify(o))},
      get lang(){return localStorage.getItem('lang')||autoLang()},
      set lang(v){localStorage.setItem('lang',v)},
      reset(){localStorage.clear()}
    };

    let view=new Date();
    let activeKey=null;
    let db=null;
    let userCode=null;
    let deferredPrompt=null;
    let confirmResolver=null;
    let installDismissed = localStorage.getItem('installDismissed') === '1';
    let appInstalled = localStorage.getItem('appInstalled') === '1';

    const firebaseConfig = {
      apiKey: "AIzaSyAMVnS-oDUU905EtHx-J8NTRNwW5xr3yMg",
      authDomain: "kefo-work-hours.firebaseapp.com",
      projectId: "kefo-work-hours",
      storageBucket: "kefo-work-hours.firebasestorage.app",
      messagingSenderId: "345952050958",
      appId: "1:345952050958:web:170e06f285cf181b1a815f"
    };

    function autoLang(){
      const nav=(navigator.language||'en').toLowerCase();
      if(nav.startsWith('ar')) return 'ar';
      if(nav.startsWith('de')) return 'de';
      if(nav.startsWith('en')) return 'en';
      return 'en';
    }

    function showConfirm(message){
      const t=i18n[store.lang]||i18n.en;
      $('#confirmTitle').textContent=t.resetConfirmTitle;
      $('#confirmMessage').textContent=message;
      $('#confirmBg').style.display='flex';
      return new Promise(res=>{
        confirmResolver=res;
      });
    }
    function closeConfirm(){
      $('#confirmBg').style.display='none';
      confirmResolver=null;
    }

    function updateAccountCodeUI(){
      const input = $('#myAccountCode');
      if(!input) return;
      input.value = userCode ? userCode : 'â€”';
    }

    function applyLang(){
      const lang=store.lang;
      const t=i18n[lang]||i18n.en;
      document.documentElement.lang=lang;
      document.documentElement.dir=(lang==='ar')?'rtl':'ltr';

      $('#appTitle').textContent=t.appTitle;
      $('#lblMonthSum').textContent=t.monthSum;
      $('#lblOT').textContent=t.overtime;
      $('#lblVisitors').textContent=t.visitors24;
      $('#lblLang').textContent=t.language;
      $('#lblPrint').textContent=t.print;
      $('#lblSettings').textContent=t.settings;
      $('#lblReset').textContent=t.reset;
      $('#lblAbout').textContent=t.about;
      $('#lblSwitchDevice').textContent=t.switchDevice;

      $('#setupTitle').textContent=t.setupTitle;
      $('#qOfficial').textContent=t.qOfficial;
      $('#hintOfficial').textContent=t.hintOfficial;
      $('#setupSkip').textContent=t.skip;
      $('#setupSave').textContent=t.next;

      $('#lblMyAccount').textContent=t.myAccountLabel;
      $('#hintMyAccount').textContent=t.myAccountHint;

      $('#lblStart').textContent=t.start;
      $('#lblEnd').textContent=t.end;
      $('#lblBreak').textContent=t.break;
      $('#lblTotal').textContent=t.total;
      $('#lblDeleteDay').textContent=t.deleteDay;
      $('#lblNow').textContent=t.now;
      $('#lblSave').textContent=t.save;

      $('#rights').textContent=t.rights;

      $('#thStartDate').textContent=t.thStartDate;
      $('#thStartTime').textContent=t.thStartTime;
      $('#thEndDate').textContent  =t.thEndDate;
      $('#thEndTime').textContent  =t.thEndTime;
      $('#thDuration').textContent =t.thDuration;
      $('#thWorked').textContent   =t.thWorked;
      $('#thBreak').textContent    =t.thBreak;
      $('#thOT').textContent       =t.thOT;
      $('#thTotal').textContent    =t.thTotal;

      $('#loginTitle').textContent = t.loginTitle;
      $('#loginDesc').textContent = t.loginDesc;
      $('#loginCodeLabel').textContent = t.loginCodeLabel;
      $('#loginHint').textContent = t.loginHint;
      $('#lblCreateUser').textContent = t.loginCreate;
      $('#lblLogin').textContent = t.loginBtn;

      $('#confirmNo').textContent = t.btnNo;
      $('#confirmYes').textContent = t.btnYes;

      // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¥Ù† ÙƒØ§Ù† Ø¸Ø§Ù‡Ø±
      const banner = $('#installBanner');
      const btnInstall = $('#btnInstallApp');
      if(!banner.hidden){
        if(isIos()){
          $('#installText').textContent = t.installIosText;
        }else{
          $('#installText').textContent = t.installAndroidText;
        }
        btnInstall.textContent = t.installBtn;
      }

      renderWeekdays();
      renderCalendarTitle();
      renderCalendar();
      updateSummary();
    }

    function renderWeekdays(){
      const t=i18n[store.lang]||i18n.en;
      const dow=$('#dow'); dow.innerHTML='';
      for(const name of t.weekdays){
        const el=document.createElement('div');
        el.className='dow';
        el.textContent=name;
        dow.appendChild(el);
      }
    }

    function renderCalendarTitle(){
      const lang=store.lang;
      $('#calTitle').textContent=
        new Intl.DateTimeFormat(lang,{month:'long',year:'numeric'}).format(view);
    }

    function renderCalendar(){
      const y=view.getFullYear(), m=view.getMonth();
      const first=new Date(y,m,1), last=new Date(y,m+1,0);
      const firstDow=(first.getDay()+6)%7;
      const daysEl=$('#days'); daysEl.innerHTML='';
      for(let i=0;i<firstDow;i++){
        const cell=document.createElement('div');
        cell.className='day disabled';
        daysEl.appendChild(cell);
      }
      const logs=store.logs;
      for(let d=1; d<=last.getDate(); d++){
        const key=toKey(y,m,d);
        const cell=document.createElement('div');
        cell.className='day';

        const num=document.createElement('div');
        num.className='dnum'; num.textContent=d;
        cell.appendChild(num);

        const badge=document.createElement('div');
        badge.className='badge';
        badge.textContent=logs[key]?fmtHM(logs[key].worked):(i18n[store.lang]||i18n.en).noData;
        cell.appendChild(badge);

        const btn=document.createElement('button');
        btn.className='edit'; btn.textContent='âœ';
        btn.onclick=()=>openDayModal(key);
        cell.appendChild(btn);

        daysEl.appendChild(cell);
      }
    }

    function updateSummary(){
      const y=view.getFullYear(), m=view.getMonth();
      const logs=store.logs; let total=0, ot=0;
      for(const k in logs){
        const [yy,mm]=k.split('-').map(Number);
        if(yy===y && mm===m+1){
          const w=logs[k].worked||0;
          total+=w;
          ot+=Math.max(0, w - store.hours*60);
        }
      }
      $('#sum-month').textContent=fmtHM(total);
      $('#sum-ot').textContent   =fmtHM(ot);
    }

    function openDayModal(key){
      activeKey=key;
      const log=store.logs[key];
      const dt=new Date(key);
      const lang=store.lang;
      $('#modalTitle').textContent=
        new Intl.DateTimeFormat(lang,{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(dt);
      $('#inStart').value=log?.start||'';
      $('#inEnd').value  =log?.end  ||'';
      $('#inBreak').value=log?.break??'';
      $('#inResult').value=log?fmtHM(log.worked):'0:00';
      $('#modalBg').style.display='flex';
    }
    function closeModal(){ $('#modalBg').style.display='none'; activeKey=null; }

    function computeDuration(start,end){
      if(!start||!end) return 0;
      const [sh,sm]=start.split(':').map(Number);
      const [eh,em]=end.split(':').map(Number);
      let s=sh*60+sm, e=eh*60+em;
      if(e<s) e+=1440;
      return e-s;
    }
    function computeWorked(start,end,brk){
      return Math.max(0, computeDuration(start,end) - (parseInt(brk)||0));
    }

    async function syncLocalLogsToFirestore(){
      if(!db || !userCode) return;
      const logs = store.logs;
      const userRef = db.collection('users').doc(userCode);
      const batch = db.batch();
      for(const key in logs){
        const logData = logs[key];
        const docRef = userRef.collection('logs').doc(key);
        batch.set(docRef, logData, {merge:true});
      }
      try{
        await batch.commit();
      }catch(e){
        console.log('sync logs error',e);
      }
    }

    function wireModal(){
      const recalc=()=>{
        $('#inResult').value = fmtHM(
          computeWorked($('#inStart').value,$('#inEnd').value,$('#inBreak').value)
        );
      };
      $('#inStart').addEventListener('input',recalc);
      $('#inEnd').addEventListener('input',recalc);
      $('#inBreak').addEventListener('input',recalc);

      $('#btnSaveDay').onclick=async ()=>{
        if(!activeKey) return;
        const t=i18n[store.lang]||i18n.en;
        const start=$('#inStart').value;
        const end  =$('#inEnd').value;
        const brk  =$('#inBreak').value||0;
        if(!start||!end){
          alert(t.errTimes);
          return;
        }
        const worked=computeWorked(start,end,brk);
        const logs=store.logs;
        logs[activeKey]={start,end,break:parseInt(brk)||0,worked};
        store.logs=logs;

        if(db && userCode){
          try{
            const userRef = db.collection('users').doc(userCode);
            await userRef.collection('logs').doc(activeKey).set(logs[activeKey]);
          }catch(e){console.log('save log error',e);}
        }

        renderCalendar(); updateSummary(); closeModal();
      };

      $('#btnDeleteDay').onclick=async ()=>{
        if(!activeKey) return;
        const logs=store.logs;
        delete logs[activeKey];
        store.logs=logs;

        if(db && userCode){
          try{
            const userRef = db.collection('users').doc(userCode);
            await userRef.collection('logs').doc(activeKey).delete();
          }catch(e){console.log('delete log error',e);}
        }

        renderCalendar(); updateSummary(); closeModal();
      };

      $('#modalClose').onclick=closeModal;
      $('#modalBg').addEventListener('click',e=>{ if(e.target.id==='modalBg') closeModal(); });

      $('#btnNow').onclick=()=>{
        const now=new Date();
        $('#inStart').value=`${pad(now.getHours())}:${pad(now.getMinutes())}`;
        $('#inEnd').value  =`${pad((now.getHours()+8)%24)}:${pad(now.getMinutes())}`;
        $('#inBreak').value=30;
        $('#inResult').value=fmtHM(
          computeWorked($('#inStart').value,$('#inEnd').value,$('#inBreak').value)
        );
      };
    }

    function buildReport(){
      const t=i18n[store.lang]||i18n.en;
      const y=view.getFullYear(), m=view.getMonth();
      $('#reportTitle').textContent=
        `${t.reportTitle} â€“ ${new Intl.DateTimeFormat(store.lang,{month:'long',year:'numeric'}).format(view)}`;
      $('#year').textContent=y;

      const body=$('#reportBody'); body.innerHTML='';
      const last=new Date(y,m+1,0);
      const logs=store.logs;

      let sumW=0, sumOT=0, sumBreak=0;

      for(let d=1; d<=last.getDate(); d++){
        const key=toKey(y,m,d);
        const log=logs[key];
        if(!log) continue;

        const dateStr=new Intl.DateTimeFormat(store.lang,{day:'2-digit',month:'2-digit',year:'numeric'}).format(new Date(y,m,d));
        const durationMins=computeDuration(log.start,log.end);
        const workedMins  =log.worked||0;
        const breakMins   =log.break||0;
        const otMins      =Math.max(0, workedMins - store.hours*60);

        sumW     += workedMins;
        sumOT    += otMins;
        sumBreak += breakMins;

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${dateStr}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${log.start||''}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${dateStr}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${log.end||''}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${fmtHM(durationMins)}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${fmtHM(workedMins)}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${fmtHM(breakMins)}</td>
          <td style="border:1px solid #777;padding:3px 4px;text-align:center">${fmtHM(otMins)}</td>
        `;
        body.appendChild(tr);
      }

      $('#tdSumWorked').textContent=fmtHM(sumW);
      $('#tdSumBreak').textContent =fmtHM(sumBreak);
      $('#tdSumOT').textContent    =fmtHM(sumOT);
    }

    function refreshVisibility(){
      const hasHours=store.hours>0;
      $('#setup').hidden  =hasHours;
      $('#calendar').hidden=!hasHours;
    }

    function initSetup(){
      const input=$('#officialHours');
      if(store.hours>0) input.value=store.hours;

      $('#setupSave').onclick=async ()=>{
        const val=parseFloat(input.value);
        const t=i18n[store.lang]||i18n.en;
        if(!val||val<=0||val>24){
          alert(t.errHours);
          return;
        }
        store.hours=val;

        if(db && userCode){
          try{
            await db.collection('users').doc(userCode).set({
              officialDailyHours:val
            },{merge:true});
          }catch(e){console.log('update hours error',e);}
        }

        refreshVisibility(); renderCalendar(); updateSummary();
      };
      $('#setupSkip').onclick=async ()=>{
        store.hours=8;

        if(db && userCode){
          try{
            await db.collection('users').doc(userCode).set({
              officialDailyHours:8
            },{merge:true});
          }catch(e){console.log('update hours error',e);}
        }

        refreshVisibility(); renderCalendar(); updateSummary();
      };
      $('#btnEditPolicy').onclick=()=>{
        $('#setup').hidden=false;
        $('#calendar').hidden=true;
      };
    }

    function wireLang(){
      const sel=$('#langSwitcher');
      sel.value=store.lang;
      sel.addEventListener('change',async ()=>{
        store.lang=sel.value;
        applyLang();

        if(db && userCode){
          try{
            await db.collection('users').doc(userCode).set({
              lang:store.lang
            },{merge:true});
          }catch(e){console.log('update lang error',e);}
        }
      });
    }

    function wireCalendarNav(){
      $('#prevMonth').onclick=()=>{
        view=new Date(view.getFullYear(),view.getMonth()-1,1);
        renderCalendarTitle();
        renderCalendar();
        updateSummary();
      };
      $('#nextMonth').onclick=()=>{
        view=new Date(view.getFullYear(),view.getMonth()+1,1);
        renderCalendarTitle();
        renderCalendar();
        updateSummary();
      };
      $('#btnResetAll').onclick=async ()=>{
        const t=i18n[store.lang]||i18n.en;
        const ok = await showConfirm(t.resetConfirmText);
        if(ok){
          store.reset(); localStorage.removeItem('userCode');
          location.reload();
        }
      };
      $('#btnPrint').onclick=()=>{
        buildReport();
        window.print();
      };
    }

    function wireAbout(){
      $('#btnAbout').onclick=()=>{
        window.location.href = 'about.html';
      };
    }

    function wireProtection(){
      document.addEventListener('contextmenu', e => {
        e.preventDefault();
      });

      let touchTimer=null;
      document.addEventListener('touchstart', e => {
        touchTimer = setTimeout(() => {
          e.preventDefault();
        }, 600);
      }, {passive:false});

      document.addEventListener('touchend', () => {
        if(touchTimer) clearTimeout(touchTimer);
      });
    }

    function isIos(){
      return /iphone|ipad|ipod/i.test(navigator.userAgent);
    }
    function isMobile(){
      return /android|iphone|ipad|ipod/i.test(navigator.userAgent);
    }
    function isStandalone(){
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    }

    function setupInstallBanner(){
      const banner = $('#installBanner');
      const btnInstall = $('#btnInstallApp');
      const btnClose = $('#btnInstallClose');

      // Ù„Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙØªÙˆØ­ ÙƒÙ€ PWA Ø£Ùˆ Ù…Ø¹Ù„Ù… Ø£Ù†Ù‡ Ù…ÙØ«Ø¨Øª Ø£Ùˆ ØªÙ… Ø¥ØºÙ„Ø§Ù‚Ù‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§ â†’ Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
      if(isStandalone() || appInstalled || installDismissed){
        banner.hidden = true;
        return;
      }

      const t=i18n[store.lang]||i18n.en;

      btnClose.onclick = () => {
        banner.hidden = true;
        installDismissed = true;
        localStorage.setItem('installDismissed','1');
      };

      btnInstall.onclick = async () => {
        if(deferredPrompt){
          deferredPrompt.prompt();
          try{
            await deferredPrompt.userChoice;
          }catch(_){}
          deferredPrompt = null;
          banner.hidden = true;
          installDismissed = true;
          appInstalled = true;
          localStorage.setItem('installDismissed','1');
          localStorage.setItem('appInstalled','1');
        }else{
          // iOS: ÙÙ‚Ø· Ù†ØµÙŠØ­Ø©
          if(isIos()){
            alert(t.installIosText);
          }
        }
      };

      // Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: Ù†Ù†ØªØ¸Ø± beforeinstallprompt â†’ Ø³ÙŠÙØ¸Ù‡Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ù…Ù† Ù‡Ù†Ø§Ùƒ
      // iOS: Ù†Ø¸Ù‡Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ù†ØµÙŠØ­Ø© ÙÙ‚Ø·
      if(isMobile() && isIos() && !isStandalone() && !installDismissed){
        $('#installText').textContent = t.installIosText;
        btnInstall.textContent = t.installBtn;
        banner.hidden = false;
      }
    }

    // Service Worker
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('./sw.js').catch(err=>console.log('SW failed',err));
      });
    }

    function initFirebase(){
      if(typeof firebase === 'undefined'){ return; }
      try{
        if(firebase.apps && !firebase.apps.length){
          firebase.initializeApp(firebaseConfig);
        }else if(!firebase.apps){
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        trackVisitorLast24h();
      }catch(err){
        console.log('Firebase init error', err);
      }
    }

    function trackVisitorLast24h(){
      if(!db) return;
      const visitsRef = db.collection('visits');
      const now = new Date();

      visitsRef.add({
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        userAgent: navigator.userAgent || '',
        createdAt: now.toISOString()
      }).catch(err=>console.log('visit add error',err));

      const cutoff = new Date(now.getTime() - 24*60*60*1000);
      visitsRef
        .where('ts','>=',cutoff)
        .get()
        .then(snap=>{
          $('#visitors24h').textContent = snap.size;
        })
        .catch(err=>{
          console.log('visits query error',err);
        });
    }

    function openLoginModal(){
      $('#loginBg').style.display='flex';
    }
    function closeLoginModal(){
      $('#loginBg').style.display='none';
    }

    async function loadUserDataFromFirestore(){
      if(!db || !userCode) return;
      try{
        const userRef = db.collection('users').doc(userCode);
        const snap = await userRef.get();
        if(snap.exists){
          const data = snap.data() || {};
          if(data.officialDailyHours){
            store.hours = data.officialDailyHours;
          }
          if(data.lang){
            store.lang = data.lang;
          }
        }

        const logsSnap = await userRef.collection('logs').get();
        const logsObj={};
        logsSnap.forEach(doc=>{
          logsObj[doc.id]=doc.data();
        });
        if(Object.keys(logsObj).length){
          store.logs = logsObj;
        }
      }catch(e){
        console.log('load user error',e);
        alert('Cloud sync error (Firestore Rules?)');
      }

      updateAccountCodeUI();
      applyLang();
      refreshVisibility();
      renderCalendar();
      updateSummary();
    }

    function wireLoginModal(){
      const btnCreate = $('#btnCreateUser');
      const btnLogin = $('#btnLoginCode');

      btnCreate.onclick = async ()=>{
        const t=i18n[store.lang]||i18n.en;
        const code = 'KeFo' + Math.floor(100000 + Math.random()*900000);
        userCode = code;
        localStorage.setItem('userCode', code);
        updateAccountCodeUI();

        if(db){
          try{
            const userRef = db.collection('users').doc(code);
            await userRef.set({
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdAtISO: new Date().toISOString(),
              officialDailyHours: store.hours || 8,
              lang: store.lang
            },{merge:true});

            await syncLocalLogsToFirestore();

          }catch(e){console.log('create user error',e);}
        }

        alert((t.loginCodeMsg||'Your login code:') + ' ' + code);
        closeLoginModal();
        loadUserDataFromFirestore();
      };

      btnLogin.onclick = async ()=>{
        const t=i18n[store.lang]||i18n.en;
        const code = $('#loginCodeInput').value.trim();
        if(!code){
          alert(t.loginEmpty || 'Please enter your code.');
          return;
        }
        userCode = code;
        localStorage.setItem('userCode', code);

        if(db){
          try{
            const snap = await db.collection('users').doc(code).get();
            if(!snap.exists){
              alert(t.loginNotFound || 'Code not found.');
              localStorage.removeItem('userCode');
              userCode=null;
              updateAccountCodeUI();
              return;
            }
          }catch(e){
            console.log('login error',e);
            alert('Cloud error on login');
          }
        }

        updateAccountCodeUI();
        closeLoginModal();
        loadUserDataFromFirestore();
      };

      $('#loginClose').onclick = closeLoginModal;
      $('#loginBg').addEventListener('click', e=>{
        if(e.target.id === 'loginBg') closeLoginModal();
      });
    }

    function wireAccountButtons(){
      const btnSwitch = $('#btnSwitchDevice');
      btnSwitch.onclick = ()=>{
        const t=i18n[store.lang]||i18n.en;
        if(!userCode){
          alert(t.loginEmpty || 'Please enter your code or create one first.');
          openLoginModal();
          return;
        }
        alert((t.switchDeviceHint || 'Use this code on your new device:') + ' ' + userCode);
      };
    }

    function initLoginFlow(){
      wireLoginModal();
      const saved = localStorage.getItem('userCode');
      if(saved){
        userCode = saved;
        updateAccountCodeUI();
        loadUserDataFromFirestore();
      }else{
        updateAccountCodeUI();
        openLoginModal();
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const yr=new Date().getFullYear();
      $('#yearFoot').textContent=yr;
      $('#year').textContent=yr;

      if(!localStorage.getItem('lang')) store.lang=autoLang();

      // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯
      $('#confirmNo').onclick=()=>{
        if(confirmResolver) confirmResolver(false);
        closeConfirm();
      };
      $('#confirmYes').onclick=()=>{
        if(confirmResolver) confirmResolver(true);
        closeConfirm();
      };
      $('#confirmClose').onclick=()=>{
        if(confirmResolver) confirmResolver(false);
        closeConfirm();
      };
      $('#confirmBg').addEventListener('click', e=>{
        if(e.target.id==='confirmBg'){
          if(confirmResolver) confirmResolver(false);
          closeConfirm();
        }
      });

      // Ù„Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ ÙØ¹Ù„Ø§Ù‹ ÙƒÙ€ PWA â†’ Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ«Ø¨ÙŠØª
      if(isStandalone()){
        installDismissed = true;
        appInstalled = true;
        localStorage.setItem('installDismissed','1');
        localStorage.setItem('appInstalled','1');
        const banner = $('#installBanner');
        if(banner) banner.hidden = true;
      }

      wireLang();
      initSetup();
      wireCalendarNav();
      wireModal();
      wireAbout();
      wireProtection();
      setupInstallBanner();
      initFirebase();
      initLoginFlow();
      wireAccountButtons();
      applyLang();
      refreshVisibility();
      renderCalendar(); updateSummary();
    });

    window.addEventListener('beforeinstallprompt', (e)=>{
      // Ù„Ù„Ù…ØªØµÙØ­ (Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙÙ‚Ø·)
      if(!isMobile() || isIos() || isStandalone() || installDismissed || appInstalled) return;
      e.preventDefault();
      deferredPrompt = e;
      const t = i18n[store.lang]||i18n.en;
      const banner = $('#installBanner');
      const btnInstall = $('#btnInstallApp');

      $('#installText').textContent = t.installAndroidText;
      btnInstall.textContent = t.installBtn;
      banner.hidden = false;
    });

    // Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯)
    window.addEventListener('appinstalled', ()=>{
      appInstalled = true;
      installDismissed = true;
      localStorage.setItem('appInstalled','1');
      localStorage.setItem('installDismissed','1');
      const banner = $('#installBanner');
      if(banner) banner.hidden = true;
    });
  </script>
</body>
</html>
